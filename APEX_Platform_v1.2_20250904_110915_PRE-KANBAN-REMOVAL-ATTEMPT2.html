<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APEX - AV Project Execution Platform</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        /* ==================== VARIABLES ==================== */
        :root {
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --success-500: #22c55e;
            --success-600: #16a34a;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            --danger-500: #ef4444;
            --danger-600: #dc2626;
            --nav-height: 70px;
            --sidebar-width: 280px;
        }

        [data-theme="dark"] {
            --gray-50: #000000;
            --gray-100: #111111;
            --gray-200: #1a1a1a;
            --gray-300: #2a2a2a;
            --gray-800: #e0e0e0;
            --gray-900: #e8e8e8;
        }

        /* ==================== BASE STYLES ==================== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            font-size: 14px;
            line-height: 1.5;
            min-height: 100vh;
            padding-top: var(--nav-height);
        }

        /* ==================== STATIC NAVIGATION ==================== */
        .app-navigation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: var(--gray-900);
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .nav-content {
            max-width: none;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.25rem;
        }

        .nav-title {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .nav-center {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-breadcrumb {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .breadcrumb-separator {
            opacity: 0.5;
        }

        .breadcrumb-current {
            color: white;
            font-weight: 500;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .nav-btn.primary {
            background: var(--primary-500);
        }

        .nav-btn.primary:hover {
            background: var(--primary-600);
        }

        .nav-btn.active {
            background: var(--primary-600);
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.3);
        }

        /* Connection Status & User Menu (same as before) */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            font-size: 0.75rem;
            color: white;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-500);
            animation: pulse 2s infinite;
        }

        .user-menu {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-500);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        /* ==================== MAIN LAYOUT ==================== */
        .app-layout {
            display: flex;
            min-height: calc(100vh - var(--nav-height));
        }

        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--gray-200);
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-x: auto;
        }

        /* ==================== SIDEBAR ==================== */
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .sidebar-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .sidebar-subtitle {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            padding: 0 1.5rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 200ms;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .nav-item:hover {
            background: var(--gray-50);
            color: var(--primary-600);
        }

        .nav-item.active {
            background: var(--primary-50);
            color: var(--primary-700);
            border-right: 3px solid var(--primary-500);
        }

        .nav-item-icon {
            margin-right: 0.75rem;
            font-size: 1.125rem;
            width: 20px;
        }

        .nav-item-text {
            flex: 1;
            font-weight: 500;
        }

        .nav-item-badge {
            background: var(--gray-200);
            color: var(--gray-700);
            padding: 0.125rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .nav-item.active .nav-item-badge {
            background: var(--primary-100);
            color: var(--primary-700);
        }

        /* ==================== CONTENT VIEWS ==================== */
        .content-view {
            display: none;
        }

        .content-view.active {
            display: block;
        }

        .content-header {
            margin-bottom: 2rem;
        }

        .content-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .content-subtitle {
            color: var(--gray-600);
            font-size: 1rem;
        }

        .content-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* ==================== DASHBOARD METRICS ==================== */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--gray-200);
            transition: transform 200ms;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .metric-icon.primary {
            background: var(--primary-100);
            color: var(--primary-700);
        }

        .metric-icon.success {
            background: #dcfce7;
            color: var(--success-600);
        }

        .metric-icon.warning {
            background: #fef3c7;
            color: var(--warning-600);
        }

        .metric-icon.danger {
            background: #fee2e2;
            color: var(--danger-600);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        .metric-change {
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        .metric-change.positive {
            color: var(--success-600);
        }

        .metric-change.negative {
            color: var(--danger-600);
        }

        .metric-change.neutral {
            color: var(--gray-500);
        }

        /* ==================== CHARTS ==================== */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--gray-200);
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chart-action {
            background: var(--gray-100);
            border: none;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 200ms;
        }

        .chart-action:hover {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .chart-action.active {
            background: var(--primary-100);
            color: var(--primary-700);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 1rem;
        }

        .chart-container canvas {
            max-height: 100%;
        }

        .chart-legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.875rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 0.125rem;
        }

        /* ==================== TABLES ==================== */
        .data-table {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }

        .table-header {
            background: var(--gray-50);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        td {
            color: var(--gray-900);
        }

        tr:hover {
            background: var(--gray-50);
        }

        /* ==================== STATUS BADGES ==================== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.active {
            background: #dcfce7;
            color: var(--success-700);
        }

        .status-badge.completed {
            background: var(--primary-100);
            color: var(--primary-700);
        }

        .status-badge.on-hold {
            background: #fef3c7;
            color: var(--warning-700);
        }

        .status-badge.cancelled {
            background: #fee2e2;
            color: var(--danger-700);
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-500);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-600);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        /* ==================== ADMINISTRATION STYLES ==================== */
        .admin-tabs {
            display: flex;
            border-bottom: 2px solid var(--gray-200);
            margin-bottom: 1.5rem;
            gap: 0.5rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            color: var(--gray-600);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--primary-600);
            background: var(--gray-50);
        }

        .tab-btn.active {
            color: var(--primary-600);
            border-bottom-color: var(--primary-500);
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-section {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .section-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .section-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .search-input {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            min-width: 200px;
        }

        .filter-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            background: white;
            min-width: 150px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .data-table th {
            background: var(--gray-50);
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .data-table tr:hover {
            background: var(--gray-50);
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-500);
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.active {
            background: var(--success-500);
            color: white;
        }

        .status-badge.inactive {
            background: var(--gray-400);
            color: white;
        }

        .status-badge.pending {
            background: var(--warning-500);
            color: white;
        }

        .roles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .role-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .role-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .role-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .role-users-count {
            background: var(--gray-100);
            color: var(--gray-600);
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
        }

        .permission-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .permission-item.granted {
            color: var(--success-600);
        }

        .settings-form {
            max-width: 600px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 400;
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .users-table-container,
        .audit-table-container {
            overflow-x: auto;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
        }

        .action-btn {
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            margin-right: 0.25rem;
        }

        .action-btn.edit {
            background: var(--primary-100);
            color: var(--primary-700);
        }

        .action-btn.delete {
            background: var(--danger-100);
            color: var(--danger-700);
        }

        .action-btn.reset {
            background: var(--warning-100);
            color: var(--warning-700);
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 1024px) {
            .app-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
                max-height: 200px;
                overflow-y: auto;
            }
            
            .main-content {
                order: 1;
                padding: 1rem;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .nav-content {
                padding: 0 1rem;
            }
            
            .nav-title {
                display: none;
            }
            
            .nav-breadcrumb {
                display: none;
            }
            
            .main-content {
                padding: 1rem 0.5rem;
            }
        }

        /* ==================== UTILITY CLASSES ==================== */
        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* ==================== REPORTS STYLING ==================== */
        .reports-container {
            padding: 1.5rem;
        }

        .reports-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .reports-header h3 {
            margin: 0;
            color: var(--gray-900);
            font-size: 1.5rem;
        }

        .report-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .form-select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            background: white;
            font-size: 0.875rem;
            min-width: 150px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-header h4 {
            margin: 0;
            color: var(--gray-900);
            font-size: 1.1rem;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
        }

        .chart-toggle {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            border: 1px solid var(--gray-300);
            background: white;
            color: var(--gray-600);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-toggle:hover {
            background: var(--gray-50);
            color: var(--gray-900);
        }

        .chart-toggle.active {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }

        .report-tables {
            margin-top: 2rem;
        }

        .report-section {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .report-section h4 {
            margin: 0 0 1rem 0;
            color: var(--gray-900);
            font-size: 1.1rem;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .report-table th {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
        }

        .report-table td {
            border: 1px solid var(--gray-200);
            padding: 0.75rem;
            vertical-align: middle;
        }

        .report-table tr:hover {
            background: var(--gray-50);
        }

        .progress-bar {
            position: relative;
            width: 100px;
            height: 20px;
            background: var(--gray-200);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .text-danger { color: #dc2626; }
        .text-warning { color: #d97706; }
        .text-success { color: #16a34a; }
        .text-muted { color: var(--gray-500); }

        .risk-indicator {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .risk-indicator.risk-low {
            background-color: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .risk-indicator.risk-medium {
            background-color: rgba(245, 158, 11, 0.1);
            color: #d97706;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .risk-indicator.risk-high {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Responsive design for reports */
        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .reports-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .report-controls {
                flex-direction: column;
                width: 100%;
            }
            
            .chart-card {
                padding: 1rem;
            }
            
            .progress-bar {
                width: 80px;
                height: 16px;
            }
            
            .progress-text {
                font-size: 0.625rem;
            }
        }

        /* ==================== EXPORT MODAL STYLING ==================== */
        .export-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .export-modal {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 450px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .export-modal-header {
            padding: 1.5rem 1.5rem 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .export-modal-header h3 {
            margin: 0;
            color: var(--gray-900);
            font-size: 1.25rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-400);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .export-modal-body {
            padding: 1.5rem;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .export-option-btn {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 1rem;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .export-option-btn:hover {
            border-color: var(--primary-300);
            background: var(--primary-50);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .export-option-btn small {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* ==================== NOTIFICATION STYLING ==================== */
        .notification {
            position: fixed;
            top: 100px;
            right: 1rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid var(--primary-500);
            padding: 1rem;
            z-index: 9999;
            max-width: 350px;
            animation: slideIn 0.3s ease-out;
        }

        .notification-success {
            border-left-color: #22c55e;
        }

        .notification-error {
            border-left-color: #ef4444;
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ==================== PROJECT MANAGEMENT STYLING ==================== */
        .projects-container {
            padding: 1.5rem;
        }

        .projects-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .projects-header h3 {
            margin: 0;
            color: var(--gray-900);
            font-size: 1.5rem;
        }

        .projects-controls {
            display: flex;
            gap: 0.75rem;
        }

        .projects-filter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-separator {
            width: 1px;
            height: 24px;
            background: var(--gray-300);
            margin: 0 0.5rem;
        }

        .filter-tab {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            background: white;
            color: var(--gray-600);
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .filter-tab:hover {
            background: var(--gray-50);
            color: var(--gray-900);
        }

        .filter-tab.active {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-box input {
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            width: 250px;
        }

        .search-icon {
            position: absolute;
            right: 0.75rem;
            color: var(--gray-400);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .project-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-300);
        }

        .project-card.overdue {
            border-left: 4px solid #ef4444;
        }

        .project-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .project-title {
            margin: 0;
            color: var(--gray-900);
            font-size: 1.1rem;
            font-weight: 600;
            line-height: 1.2;
            flex: 1;
        }

        .project-menu {
            margin-left: 0.5rem;
        }

        .menu-btn {
            background: none;
            border: none;
            color: var(--gray-400);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }

        .menu-btn:hover {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .project-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .project-client {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .project-type {
            background: var(--gray-100);
            color: var(--gray-700);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .project-details {
            margin-bottom: 1rem;
        }

        .project-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
        }

        .detail-label {
            color: var(--gray-500);
            font-weight: 500;
            flex-shrink: 0;
        }

        .detail-value {
            color: var(--gray-800);
            font-weight: 600;
            text-align: right;
            margin-left: 0.5rem;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .project-progress {
            margin-bottom: 1rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .project-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .project-timeline {
            padding-top: 1rem;
            border-top: 1px solid var(--gray-100);
        }

        .timeline-item {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .timeline-item.overdue {
            color: #ef4444;
            font-weight: 600;
        }

        .timeline-item.due-soon {
            color: #f59e0b;
            font-weight: 600;
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-500);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .loading-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        /* Project Modal */
        .project-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 1rem;
        }

        .project-modal {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem 1.5rem 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--gray-900);
            font-size: 1.25rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-footer {
            padding: 1rem 1.5rem 1.5rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Project Modal Overlay Styles */
        .project-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Project Menu Dropdown Styles */
        .project-menu-dropdown {
            position: fixed;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            min-width: 160px;
            z-index: 2000;
            padding: 0.5rem 0;
            animation: fadeIn 0.15s ease-out;
        }

        .project-menu-dropdown .menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.15s;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .project-menu-dropdown .menu-item:hover {
            background: var(--gray-50);
        }

        .project-menu-dropdown .menu-item.danger {
            color: var(--red-600);
        }

        .project-menu-dropdown .menu-item.danger:hover {
            background: rgba(239, 68, 68, 0.05);
        }

        .project-menu-dropdown .menu-icon {
            font-size: 1rem;
            width: 1.25rem;
            text-align: center;
        }

        .project-menu-dropdown .menu-separator {
            height: 1px;
            background: var(--gray-200);
            margin: 0.5rem 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Project Detail Modal Styles */
        .project-detail-modal {
            width: 90vw;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .project-detail-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .detail-section {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .detail-section:last-child {
            border-bottom: none;
        }

        .detail-section h4 {
            margin: 0 0 1rem 0;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .detail-item.full-width {
            grid-column: 1 / -1;
        }

        .detail-item label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-600);
        }

        .detail-item span, .detail-item p {
            font-size: 0.875rem;
            color: var(--gray-900);
        }

        .description-text {
            margin: 0;
            line-height: 1.5;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-container .progress-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-container .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.75rem;
            font-weight: 500;
            min-width: 35px;
        }

        .priority-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .priority-badge.low {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }

        .priority-badge.medium {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }

        .priority-badge.high {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        .priority-badge.critical {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        /* Tasks Section Styles */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .tasks-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .no-tasks {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--gray-500);
        }

        .no-tasks-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .no-tasks p {
            margin: 0.5rem 0;
        }

        .text-muted {
            font-size: 0.875rem;
            color: var(--gray-400);
        }

        .task-item {
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: white;
            transition: all 0.2s ease;
        }

        .task-item:hover {
            border-color: var(--gray-300);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            font-weight: 500;
            color: var(--gray-900);
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .task-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .task-status.not-started {
            background: rgba(107, 114, 128, 0.1);
            color: #6b7280;
        }

        .task-status.in-progress {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }

        .task-status.completed {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }

        .task-status.on-hold {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        .task-priority {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .task-assignee {
            font-size: 0.75rem;
            color: var(--gray-600);
        }

        .task-actions {
            display: flex;
            gap: 0.25rem;
        }

        .btn-icon {
            background: none;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
            font-size: 0.875rem;
        }

        .btn-icon:hover {
            background: var(--gray-100);
        }

        .task-description {
            margin: 0.75rem 0 0.5rem 0;
            font-size: 0.875rem;
            color: var(--gray-600);
            line-height: 1.4;
        }

        .task-details {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .task-detail {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Task Modal Styles */
        .task-modal {
            width: 600px;
            max-width: 90vw;
        }

        /* Executive Summary Styles */
        .tab-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            background: white;
            color: var(--gray-600);
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .tab-btn:hover {
            background: var(--gray-50);
            color: var(--gray-900);
        }

        .tab-btn.active {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--gray-200);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-600);
            margin-bottom: 0.5rem;
        }

        .kpi-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        .executive-section {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .executive-section h4 {
            margin: 0 0 1rem 0;
            color: var(--gray-900);
            font-size: 1.1rem;
        }

        .insights-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .insight-card {
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid;
        }

        .insight-success {
            background: rgba(34, 197, 94, 0.05);
            border-color: #22c55e;
        }

        .insight-warning {
            background: rgba(245, 158, 11, 0.05);
            border-color: #f59e0b;
        }

        .insight-info {
            background: rgba(59, 130, 246, 0.05);
            border-color: #3b82f6;
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .financial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .financial-metric {
            text-align: center;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 0.5rem;
        }

        .financial-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .financial-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .critical-project-item {
            padding: 1rem;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .critical-project-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .critical-project-details {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.875rem;
        }

        .overdue-badge {
            background: #ef4444;
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .no-critical {
            text-align: center;
            padding: 2rem;
            color: var(--gray-500);
            font-style: italic;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .projects-filter {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-tabs {
                justify-content: center;
            }

            .search-box input {
                width: 100%;
            }

            .projects-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .financial-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ==================== LOGIN SCREEN STYLING ==================== */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-container {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            width: 100%;
            max-width: 450px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            margin: 0 0 0.5rem 0;
            color: var(--gray-900);
            font-size: 1.75rem;
            font-weight: 700;
        }

        .login-header p {
            margin: 0;
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .login-form {
            margin-bottom: 2rem;
        }

        .login-form .form-group {
            margin-bottom: 1rem;
        }

        .login-form label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .login-form input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .login-demo {
            border-top: 1px solid var(--gray-200);
            padding-top: 2rem;
        }

        .login-demo h4 {
            margin: 0 0 1rem 0;
            color: var(--gray-700);
            font-size: 0.875rem;
            text-align: center;
        }

        .demo-accounts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .demo-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            background: var(--gray-50);
            color: var(--gray-700);
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .demo-btn:hover {
            background: var(--gray-100);
            border-color: var(--primary-300);
            color: var(--primary-700);
        }

        /* Hide main navigation when not logged in */
        body:not(.logged-in) .app-navigation {
            display: none;
        }

        /* ==================== PROJECT VIEW STYLES ==================== */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            padding: 1rem 0;
            width: 100%;
            min-height: calc(100vh - 300px);
        }

        .kanban-column {
            background: var(--gray-50);
            border-radius: 0.75rem;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 280px);
            min-width: 0;
            border: 1px solid var(--gray-200);
        }

        .kanban-column-header {
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border-bottom: 2px solid var(--gray-200);
            border-radius: 0.75rem 0.75rem 0 0;
            flex-shrink: 0;
        }

        .kanban-column-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            color: var(--gray-800);
        }

        .kanban-status-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .kanban-status-icon.draft { background: var(--gray-100); }
        .kanban-status-icon.active { background: var(--success-100); }
        .kanban-status-icon.on-hold { background: var(--warning-100); }
        .kanban-status-icon.completed { background: var(--primary-100); }
        .kanban-status-icon.cancelled { background: var(--danger-100); }

        .kanban-count {
            background: var(--gray-900);
            color: white;
            padding: 0.25rem 0.625rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }

        .kanban-projects {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .kanban-project {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        .kanban-project:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-300);
        }

        .kanban-project-title {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .kanban-project-info {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .kanban-project-meta {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.75rem;
            color: var(--gray-600);
        }

        .kanban-project-meta svg,
        .kanban-project-meta span:first-child {
            color: var(--gray-400);
            font-size: 0.75rem;
        }

        .kanban-progress {
            margin-top: 0.5rem;
        }

        .kanban-progress-bar {
            height: 4px;
            background: var(--gray-200);
            border-radius: 2px;
            overflow: hidden;
        }

        .kanban-progress-fill {
            height: 100%;
            background: var(--primary-500);
            transition: width 0.3s;
        }

        .kanban-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            color: var(--gray-400);
            font-size: 0.875rem;
            text-align: center;
        }

        .kanban-empty-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .kanban-board {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .kanban-board {
                grid-template-columns: 1fr;
            }
            .kanban-column {
                height: 400px;
            }
        }

        .calendar-view {
            padding: 1rem 0;
        }

        .calendar-month {
            margin-bottom: 2rem;
        }

        .calendar-month-header {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-500);
        }

        .calendar-projects {
            display: grid;
            gap: 0.75rem;
        }

        .calendar-project {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.375rem;
            padding: 1rem;
            border-left: 4px solid var(--primary-500);
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-project:hover {
            border-color: var(--primary-300);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-project h4 {
            margin: 0 0 0.5rem 0;
            color: var(--gray-900);
        }

        .calendar-project-dates {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .calendar-project-meta {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .list-view {
            /* Reuse existing grid styles */
        }

        /* ==================== ADVANCED SEARCH STYLES ==================== */
        .advanced-search-container {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .quick-search-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .search-input-container {
            flex: 1;
            position: relative;
        }

        .global-search-input {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .global-search-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        .search-input-container .search-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            pointer-events: none;
        }

        .advanced-filters-panel {
            padding: 1.5rem;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .filter-group {
            background: white;
            padding: 1rem;
            border-radius: 0.375rem;
            border: 1px solid var(--gray-200);
        }

        .filter-label {
            display: block;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }

        .filter-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-checkboxes label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }

        .filter-checkboxes label:hover {
            background: var(--gray-100);
        }

        .filter-checkboxes input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .date-filters, .budget-filters {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .date-filters label, .budget-filters label {
            font-size: 0.75rem;
            color: var(--gray-600);
            margin-bottom: 0.25rem;
        }

        .date-filters input, .budget-filters input {
            padding: 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }

        .progress-filters {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto;
            gap: 0.5rem;
            align-items: center;
        }

        .progress-filters input[type="range"] {
            width: 100%;
        }

        .progress-filters span {
            font-size: 0.75rem;
            color: var(--gray-600);
            text-align: center;
            min-width: 3rem;
        }

        .quick-presets {
            background: white;
            padding: 1rem;
            border-radius: 0.375rem;
            border: 1px solid var(--gray-200);
        }

        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .results-info {
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .filter-count {
            background: var(--primary-100);
            color: var(--primary-700);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }

        .results-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            font-size: 0.875rem;
        }

        .results-controls label {
            color: var(--gray-600);
            font-weight: 500;
        }

        .results-controls select {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.25rem;
            font-size: 0.875rem;
            background: white;
        }

        /* Responsive Design for Advanced Search */
        @media (max-width: 1200px) {
            .filters-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .quick-search-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            
            .search-results-header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            
            .results-controls {
                justify-content: center;
            }
            
            .preset-buttons {
                justify-content: center;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Static Navigation Header -->
    <nav class="app-navigation">
        <div class="nav-content">
            <div class="nav-brand">
                <div class="nav-logo">AP</div>
                <div class="nav-title">APEX Platform</div>
            </div>

            <div class="nav-center">
                <div class="nav-breadcrumb">
                    <span id="breadcrumbRoot">Dashboard</span>
                    <span class="breadcrumb-separator"></span>
                    <span class="breadcrumb-current" id="breadcrumbCurrent">Overview</span>
                </div>
            </div>

            <div class="nav-actions">
                <!-- Connection Status -->
                <div class="connection-status">
                    <div class="status-dot" id="connectionDot"></div>
                    <span id="connectionText">Connected</span>
                </div>

                <!-- Navigation Buttons -->
                <button class="nav-btn" onclick="showView('dashboard')" id="navDashboard">
                     Dashboard
                </button>
                <button class="nav-btn" onclick="showView('projects')" id="navProjects">
                     Projects
                </button>
                <button class="nav-btn" onclick="showView('reports')" id="navReports">
                     Reports
                </button>
                <button class="nav-btn" onclick="showView('admin')" id="navAdmin">
                     Administration
                </button>
                <button class="nav-btn primary" onclick="showCreateProject()">
                     New Project
                </button>

                <!-- User Menu -->
                <div class="user-menu">
                    <div class="user-avatar" onclick="toggleUserMenu()" id="userAvatar">A</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-header">
                <h1> APEX</h1>
                <p>AV Project Execution Platform - Wintrust Unified Communications</p>
            </div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" name="email" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" name="password" required placeholder="Enter your password">
                </div>
                <button type="submit" class="btn btn-primary login-btn">Sign In</button>
            </form>
            
            <div class="login-demo">
                <h4>Demo Accounts:</h4>
                <div class="demo-accounts">
                    <button type="button" onclick="quickLogin('admin@company.com', 'admin123')" class="demo-btn"> Admin</button>
                    <button type="button" onclick="quickLogin('pm@company.com', 'pm123')" class="demo-btn"> Project Manager</button>
                    <button type="button" onclick="quickLogin('tech@company.com', 'tech123')" class="demo-btn"> Technician</button>
                    <button type="button" onclick="quickLogin('client@company.com', 'client123')" class="demo-btn"> Client</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application Layout -->
    <div class="app-layout" id="mainApp" style="display: none;">
        <!-- Dynamic Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title" id="sidebarTitle">Dashboard</h2>
                <p class="sidebar-subtitle" id="sidebarSubtitle">Project overview and metrics</p>
            </div>
            
            <nav class="sidebar-nav" id="sidebarNav">
                <!-- Dynamic navigation content -->
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Dashboard View -->
            <div id="dashboardView" class="content-view active">
                <div class="content-header">
                    <h1 class="content-title">APEX Dashboard</h1>
                    <p class="content-subtitle">Real-time overview of all AV projects and key performance indicators</p>
                    <div class="content-actions">
                        <button class="btn btn-primary" onclick="refreshDashboard()">
                             Refresh Data
                        </button>
                        <button class="btn btn-secondary" onclick="exportDashboard()">
                             Export Report
                        </button>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="metrics-grid" id="metricsGrid">
                    <!-- Dynamic metrics cards -->
                </div>

                <!-- Charts -->
                <div class="chart-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Project Status Distribution</h3>
                            <div class="chart-actions">
                                <button class="chart-action active" data-period="30">30d</button>
                                <button class="chart-action" data-period="90">90d</button>
                                <button class="chart-action" data-period="365">1y</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Progress Trends</h3>
                            <div class="chart-actions">
                                <button class="chart-action active" data-metric="progress">Progress</button>
                                <button class="chart-action" data-metric="budget">Budget</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Projects Table -->
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Recent Projects</h3>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-secondary" onclick="showAllProjects()">
                                View All
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>Client</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentProjectsTable">
                            <!-- Dynamic project rows -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Projects View -->
            <div id="projectsView" class="content-view">
                <div class="content-header">
                    <h1 class="content-title">All Projects</h1>
                    <p class="content-subtitle">Manage and track all your AV projects</p>
                    <div class="content-actions">
                        <button class="btn btn-primary" onclick="showCreateProject()">
                             New Project
                        </button>
                        <button class="btn btn-secondary" onclick="exportProjects()">
                             Export All
                        </button>
                    </div>
                </div>

                <div id="projectsContent">
                    <!-- Projects content will be loaded here -->
                </div>
            </div>

            <!-- Reports View -->
            <div id="reportsView" class="content-view">
                <div class="content-header">
                    <h1 class="content-title">Advanced Reports</h1>
                    <p class="content-subtitle">Comprehensive analytics and reporting for stakeholders</p>
                    <div class="content-actions">
                        <button class="btn btn-primary" onclick="generateReport()">
                             Generate Report
                        </button>
                        <button class="btn btn-secondary" onclick="scheduleReport()">
                             Schedule
                        </button>
                    </div>
                </div>

                <div id="reportsContent">
                    <!-- Reports content will be loaded here -->
                </div>
            </div>

            <!-- Administration View -->
            <div id="adminView" class="content-view">
                <div class="content-header">
                    <h1 class="content-title">System Administration</h1>
                    <p class="content-subtitle">Manage users, roles, and system settings</p>
                    <div class="content-actions">
                        <button class="btn btn-primary" onclick="showCreateUser()">
                             Add User
                        </button>
                        <button class="btn btn-secondary" onclick="showCreateRole()">
                             Create Role
                        </button>
                    </div>
                </div>

                <div id="adminContent">
                    <!-- Admin sub-navigation -->
                    <div class="admin-tabs">
                        <button class="tab-btn active" onclick="showAdminTab('users')" id="adminTabUsers">
                             Users
                        </button>
                        <button class="tab-btn" onclick="showAdminTab('roles')" id="adminTabRoles">
                             Roles & Permissions
                        </button>
                        <button class="tab-btn" onclick="showAdminTab('settings')" id="adminTabSettings">
                             System Settings
                        </button>
                        <button class="tab-btn" onclick="showAdminTab('audit')" id="adminTabAudit">
                             Audit Log
                        </button>
                    </div>

                    <!-- Users Management -->
                    <div id="adminUsersContent" class="admin-tab-content active">
                        <div class="admin-section">
                            <div class="section-header">
                                <h3>User Management</h3>
                                <div class="section-actions">
                                    <input type="text" placeholder="Search users..." class="search-input" id="userSearchInput" oninput="filterUsers()">
                                    <select class="filter-select" id="userRoleFilter" onchange="filterUsers()">
                                        <option value="">All Roles</option>
                                        <option value="admin">Administrator</option>
                                        <option value="manager">Project Manager</option>
                                        <option value="technician">Technician</option>
                                        <option value="viewer">Viewer</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="users-table-container">
                                <table class="data-table" id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Last Login</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <!-- User rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Roles Management -->
                    <div id="adminRolesContent" class="admin-tab-content">
                        <div class="admin-section">
                            <div class="section-header">
                                <h3>Roles & Permissions</h3>
                                <button class="btn btn-primary" onclick="showCreateRole()">
                                     Create Role
                                </button>
                            </div>
                            
                            <div class="roles-grid" id="rolesGrid">
                                <!-- Role cards will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- System Settings -->
                    <div id="adminSettingsContent" class="admin-tab-content">
                        <div class="admin-section">
                            <div class="section-header">
                                <h3>System Settings</h3>
                            </div>
                            
                            <div class="settings-form">
                                <div class="form-group">
                                    <label>Company Name</label>
                                    <input type="text" class="form-control" id="companyName" value="Wintrust Bank - Unified Communications">
                                </div>
                                
                                <div class="form-group">
                                    <label>Default Project Status</label>
                                    <select class="form-control" id="defaultProjectStatus">
                                        <option value="not-started">Not Started</option>
                                        <option value="planning">Planning</option>
                                        <option value="active" selected>Active</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Session Timeout (minutes)</label>
                                    <input type="number" class="form-control" id="sessionTimeout" value="60">
                                </div>
                                
                                <div class="form-group">
                                    <label>Email Notifications</label>
                                    <div class="checkbox-group">
                                        <label><input type="checkbox" checked> Project status changes</label>
                                        <label><input type="checkbox" checked> Task assignments</label>
                                        <label><input type="checkbox"> Daily summaries</label>
                                        <label><input type="checkbox"> Weekly reports</label>
                                    </div>
                                </div>
                                
                                <div class="form-actions">
                                    <button class="btn btn-primary" onclick="saveSystemSettings()">
                                         Save Settings
                                    </button>
                                    <button class="btn btn-secondary" onclick="resetSystemSettings()">
                                         Reset to Defaults
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Log -->
                    <div id="adminAuditContent" class="admin-tab-content">
                        <div class="admin-section">
                            <div class="section-header">
                                <h3>Audit Log</h3>
                                <div class="section-actions">
                                    <input type="date" class="form-control" id="auditFromDate">
                                    <input type="date" class="form-control" id="auditToDate">
                                    <select class="filter-select" id="auditActionFilter">
                                        <option value="">All Actions</option>
                                        <option value="login">Login/Logout</option>
                                        <option value="project">Project Changes</option>
                                        <option value="user">User Management</option>
                                        <option value="system">System Changes</option>
                                    </select>
                                    <button class="btn btn-secondary" onclick="filterAuditLog()">Filter</button>
                                </div>
                            </div>
                            
                            <div class="audit-table-container">
                                <table class="data-table" id="auditTable">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>User</th>
                                            <th>Action</th>
                                            <th>Resource</th>
                                            <th>Details</th>
                                            <th>IP Address</th>
                                        </tr>
                                    </thead>
                                    <tbody id="auditTableBody">
                                        <!-- Audit entries will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ==================== APPLICATION STATE ====================
        const AppState = {
            isLoggedIn: false,
            user: null,
            currentView: 'login',
            data: {
                projects: [],
                metrics: {},
                charts: {}
            },
            config: {
                apiUrl: 'http://localhost:3001/api',
                refreshInterval: 30000 // 30 seconds
            },
            users: [
                { id: 1, name: 'John Smith', email: 'admin@company.com', password: 'admin123', role: 'Admin', avatar: 'JS' },
                { id: 2, name: 'Sarah Johnson', email: 'pm@company.com', password: 'pm123', role: 'Project-Manager', avatar: 'SJ' },
                { id: 3, name: 'Mike Davis', email: 'lead@company.com', password: 'lead123', role: 'Team-Lead', avatar: 'MD' },
                { id: 4, name: 'Lisa Chen', email: 'tech@company.com', password: 'tech123', role: 'Technician', avatar: 'LC' },
                { id: 5, name: 'Tom Wilson', email: 'client@company.com', password: 'client123', role: 'Client', avatar: 'TW' }
            ],
            projects: [
                {
                    id: 'proj_2023_001',
                    name: 'Corporate Headquarters AV Upgrade',
                    requestorInfo: 'David Thompson, CTO, TechCorp Solutions, david.thompson@techcorp.com',
                    siteLocation: '1200 Technology Drive, Austin, TX 78759',
                    businessLine: 'corporate',
                    description: 'Complete audiovisual system upgrade for corporate boardrooms and training facilities. Includes 12 conference rooms, main auditorium (200 seats), and 3 training rooms. Integration of video conferencing, wireless presentation, digital signage, and centralized control systems.',
                    type: 'upgrade',
                    priority: 'high',
                    requestDate: '2023-02-15',
                    startDate: '2023-03-01',
                    dueDate: '2023-05-30',
                    endDate: '2023-05-28',
                    estimatedBudget: 485000,
                    actualBudget: 467500,
                    status: 'completed',
                    progress: 100,
                    createdAt: '2023-02-15T10:30:00.000Z',
                    updatedAt: '2023-05-28T16:45:00.000Z',
                    tasks: [
                        {
                            id: 'task_2023_001_01',
                            name: 'Site Survey and Requirements Analysis',
                            description: 'Conduct comprehensive site survey, document existing infrastructure, and finalize technical requirements with stakeholders.',
                            status: 'completed',
                            ragStatus: 'green',
                            priority: 'critical',
                            assignee: 'Mike Davis',
                            estimatedHours: 40,
                            startDate: '2023-03-01',
                            endDate: '2023-03-10',
                            notes: 'Site survey completed successfully. All technical requirements documented and approved by client. Ready for next phase.',
                            completedDate: '2023-03-10',
                            createdAt: '2023-02-20T09:00:00.000Z',
                            updatedAt: '2023-03-10T17:30:00.000Z'
                        },
                        {
                            id: 'task_2023_001_02',
                            name: 'Equipment Procurement and Staging',
                            description: 'Order all AV equipment, verify compatibility, and stage equipment for installation. Includes projectors, displays, audio systems, control processors, and cabling.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Lisa Chen',
                            estimatedHours: 32,
                            startDate: '2023-03-05',
                            endDate: '2023-03-25',
                            createdAt: '2023-02-20T09:15:00.000Z',
                            updatedAt: '2023-03-25T14:20:00.000Z'
                        },
                        {
                            id: 'task_2023_001_03',
                            name: 'Infrastructure Installation',
                            description: 'Install cable pathways, power distribution, network infrastructure, and mounting systems. Coordinate with building facilities team.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Mike Davis',
                            estimatedHours: 120,
                            startDate: '2023-03-15',
                            endDate: '2023-04-20',
                            createdAt: '2023-02-20T09:30:00.000Z',
                            updatedAt: '2023-04-20T18:00:00.000Z'
                        },
                        {
                            id: 'task_2023_001_04',
                            name: 'AV Equipment Installation and Integration',
                            description: 'Install and integrate all audiovisual equipment including displays, projectors, sound systems, control systems, and video conferencing solutions.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Lisa Chen',
                            estimatedHours: 160,
                            startDate: '2023-04-10',
                            endDate: '2023-05-15',
                            createdAt: '2023-02-20T09:45:00.000Z',
                            updatedAt: '2023-05-15T19:30:00.000Z'
                        },
                        {
                            id: 'task_2023_001_05',
                            name: 'System Programming and Configuration',
                            description: 'Program control systems, configure video conferencing, set up wireless presentation systems, and integrate with corporate network.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Mike Davis',
                            estimatedHours: 80,
                            startDate: '2023-05-01',
                            endDate: '2023-05-20',
                            createdAt: '2023-02-20T10:00:00.000Z',
                            updatedAt: '2023-05-20T16:15:00.000Z'
                        },
                        {
                            id: 'task_2023_001_06',
                            name: 'Testing and Commissioning',
                            description: 'Comprehensive system testing, performance verification, integration testing, and final commissioning with client acceptance.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 48,
                            startDate: '2023-05-18',
                            endDate: '2023-05-26',
                            createdAt: '2023-02-20T10:15:00.000Z',
                            updatedAt: '2023-05-26T15:45:00.000Z'
                        },
                        {
                            id: 'task_2023_001_07',
                            name: 'User Training and Documentation',
                            description: 'Conduct user training sessions, create operation manuals, and provide technical documentation for IT staff.',
                            status: 'completed',
                            priority: 'medium',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 24,
                            startDate: '2023-05-22',
                            endDate: '2023-05-28',
                            createdAt: '2023-02-20T10:30:00.000Z',
                            updatedAt: '2023-05-28T16:45:00.000Z'
                        }
                    ]
                },
                {
                    id: 'proj_2023_002',
                    name: 'University Lecture Hall Digital Transformation',
                    requestorInfo: 'Dr. Maria Rodriguez, Director of IT, State University, maria.rodriguez@stateuniv.edu',
                    siteLocation: '3400 University Boulevard, San Diego, CA 92182',
                    businessLine: 'education',
                    description: 'Modernization of 8 large lecture halls (150-300 seats each) with state-of-the-art presentation systems, lecture capture, interactive displays, and accessibility features. Integration with learning management system.',
                    type: 'new-build',
                    priority: 'high',
                    requestDate: '2023-05-10',
                    startDate: '2023-06-15',
                    dueDate: '2023-08-25',
                    endDate: '2023-08-23',
                    estimatedBudget: 320000,
                    actualBudget: 315800,
                    status: 'completed',
                    progress: 100,
                    createdAt: '2023-05-10T14:20:00.000Z',
                    updatedAt: '2023-08-23T17:30:00.000Z',
                    tasks: [
                        {
                            id: 'task_2023_002_01',
                            name: 'Academic Requirements Assessment',
                            description: 'Meet with faculty and IT staff to understand teaching requirements, accessibility needs, and integration with existing systems.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 32,
                            startDate: '2023-06-15',
                            endDate: '2023-06-25',
                            createdAt: '2023-05-15T11:00:00.000Z',
                            updatedAt: '2023-06-25T16:30:00.000Z'
                        },
                        {
                            id: 'task_2023_002_02',
                            name: 'Lecture Capture System Design',
                            description: 'Design automated lecture capture system with multi-camera setup, audio processing, and integration with university LMS.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Mike Davis',
                            estimatedHours: 48,
                            startDate: '2023-06-20',
                            endDate: '2023-07-05',
                            createdAt: '2023-05-15T11:15:00.000Z',
                            updatedAt: '2023-07-05T18:45:00.000Z'
                        },
                        {
                            id: 'task_2023_002_03',
                            name: 'Interactive Display Installation',
                            description: 'Install 86" interactive touchscreen displays in each lecture hall with wall mounting and cable management.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Lisa Chen',
                            estimatedHours: 64,
                            startDate: '2023-07-01',
                            endDate: '2023-07-20',
                            createdAt: '2023-05-15T11:30:00.000Z',
                            updatedAt: '2023-07-20T17:15:00.000Z'
                        },
                        {
                            id: 'task_2023_002_04',
                            name: 'Audio System Enhancement',
                            description: 'Upgrade audio systems with wireless microphone systems, hearing loop integration, and acoustic optimization.',
                            status: 'completed',
                            priority: 'medium',
                            assignee: 'Mike Davis',
                            estimatedHours: 56,
                            startDate: '2023-07-10',
                            endDate: '2023-08-02',
                            createdAt: '2023-05-15T11:45:00.000Z',
                            updatedAt: '2023-08-02T16:00:00.000Z'
                        },
                        {
                            id: 'task_2023_002_05',
                            name: 'System Integration and Testing',
                            description: 'Integrate all systems, configure lecture capture workflows, and conduct comprehensive testing with faculty.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 40,
                            startDate: '2023-08-05',
                            endDate: '2023-08-20',
                            createdAt: '2023-05-15T12:00:00.000Z',
                            updatedAt: '2023-08-20T19:30:00.000Z'
                        },
                        {
                            id: 'task_2023_002_06',
                            name: 'Faculty Training Program',
                            description: 'Develop and deliver comprehensive training program for faculty on new systems and lecture capture workflows.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 32,
                            startDate: '2023-08-15',
                            endDate: '2023-08-23',
                            createdAt: '2023-05-15T12:15:00.000Z',
                            updatedAt: '2023-08-23T17:30:00.000Z'
                        }
                    ]
                },
                {
                    id: 'proj_2024_003',
                    name: 'Hospital Emergency Department Communication System',
                    requestorInfo: 'Dr. James Mitchell, Chief Medical Officer, Regional Medical Center, j.mitchell@regionalmed.org',
                    siteLocation: '2500 Health Sciences Drive, Phoenix, AZ 85006',
                    businessLine: 'healthcare',
                    description: 'Critical communication system for emergency department including nurse call integration, patient monitoring displays, staff communication systems, and emergency broadcast capabilities. HIPAA compliant implementation.',
                    type: 'new-build',
                    priority: 'critical',
                    requestDate: '2023-11-20',
                    startDate: '2024-01-08',
                    dueDate: '2024-03-15',
                    endDate: '2024-03-12',
                    estimatedBudget: 275000,
                    actualBudget: 282400,
                    status: 'completed',
                    progress: 100,
                    createdAt: '2023-11-20T08:15:00.000Z',
                    updatedAt: '2024-03-12T20:45:00.000Z',
                    tasks: [
                        {
                            id: 'task_2024_003_01',
                            name: 'HIPAA Compliance Assessment',
                            description: 'Review HIPAA requirements, security protocols, and compliance standards for healthcare AV installations.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 24,
                            startDate: '2024-01-08',
                            endDate: '2024-01-15',
                            createdAt: '2023-11-25T10:00:00.000Z',
                            updatedAt: '2024-01-15T17:00:00.000Z'
                        },
                        {
                            id: 'task_2024_003_02',
                            name: 'Nurse Call System Integration',
                            description: 'Design integration between existing nurse call system and new communication displays for patient status updates.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Mike Davis',
                            estimatedHours: 48,
                            startDate: '2024-01-12',
                            endDate: '2024-02-05',
                            createdAt: '2023-11-25T10:15:00.000Z',
                            updatedAt: '2024-02-05T18:30:00.000Z'
                        },
                        {
                            id: 'task_2024_003_03',
                            name: 'Emergency Communication System',
                            description: 'Install emergency broadcast system with zone-based messaging, automated alerts, and backup power systems.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Lisa Chen',
                            estimatedHours: 72,
                            startDate: '2024-01-20',
                            endDate: '2024-02-25',
                            createdAt: '2023-11-25T10:30:00.000Z',
                            updatedAt: '2024-02-25T19:15:00.000Z'
                        },
                        {
                            id: 'task_2024_003_04',
                            name: 'Patient Information Displays',
                            description: 'Install and configure patient information displays with privacy filters and secure content management.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Lisa Chen',
                            estimatedHours: 40,
                            startDate: '2024-02-10',
                            endDate: '2024-03-01',
                            createdAt: '2023-11-25T10:45:00.000Z',
                            updatedAt: '2024-03-01T16:45:00.000Z'
                        },
                        {
                            id: 'task_2024_003_05',
                            name: 'System Security and Testing',
                            description: 'Implement security protocols, conduct penetration testing, and verify HIPAA compliance for all systems.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 56,
                            startDate: '2024-02-20',
                            endDate: '2024-03-10',
                            createdAt: '2023-11-25T11:00:00.000Z',
                            updatedAt: '2024-03-10T20:30:00.000Z'
                        },
                        {
                            id: 'task_2024_003_06',
                            name: 'Staff Training and Go-Live Support',
                            description: 'Train medical and IT staff on new systems, provide 24/7 go-live support, and establish ongoing support procedures.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 32,
                            startDate: '2024-03-05',
                            endDate: '2024-03-12',
                            createdAt: '2023-11-25T11:15:00.000Z',
                            updatedAt: '2024-03-12T20:45:00.000Z'
                        }
                    ]
                },
                {
                    id: 'proj_2024_004',
                    name: 'Luxury Resort Entertainment Complex',
                    requestorInfo: 'Amanda Foster, Operations Director, Oceanview Resort & Spa, a.foster@oceanviewresort.com',
                    siteLocation: '1 Paradise Bay Drive, Key Largo, FL 33037',
                    businessLine: 'hospitality',
                    description: 'Complete entertainment complex featuring main theater (400 seats), poolside projection systems, restaurant audio zones, lobby digital signage network, and outdoor event spaces with weather-resistant AV systems.',
                    type: 'new-build',
                    priority: 'medium',
                    requestDate: '2024-01-15',
                    startDate: '2024-02-20',
                    dueDate: '2024-06-30',
                    endDate: '2024-06-28',
                    estimatedBudget: 650000,
                    actualBudget: 638200,
                    status: 'completed',
                    progress: 100,
                    createdAt: '2024-01-15T13:30:00.000Z',
                    updatedAt: '2024-06-28T22:15:00.000Z',
                    tasks: [
                        {
                            id: 'task_2024_004_01',
                            name: 'Resort Environment Assessment',
                            description: 'Assess challenging installation environment including salt air, humidity, temperature variations, and aesthetic requirements.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Mike Davis',
                            estimatedHours: 40,
                            startDate: '2024-02-20',
                            endDate: '2024-03-05',
                            createdAt: '2024-01-20T14:00:00.000Z',
                            updatedAt: '2024-03-05T17:45:00.000Z'
                        },
                        {
                            id: 'task_2024_004_02',
                            name: 'Main Theater Design and Installation',
                            description: 'Design and install complete theater system including projection, surround sound, stage lighting, and control systems.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Lisa Chen',
                            estimatedHours: 120,
                            startDate: '2024-03-01',
                            endDate: '2024-04-30',
                            createdAt: '2024-01-20T14:15:00.000Z',
                            updatedAt: '2024-04-30T19:30:00.000Z'
                        },
                        {
                            id: 'task_2024_004_03',
                            name: 'Outdoor Weather-Resistant Systems',
                            description: 'Install outdoor projection and audio systems with IP65 rated enclosures and environmental protection.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Mike Davis',
                            estimatedHours: 88,
                            startDate: '2024-03-15',
                            endDate: '2024-05-15',
                            createdAt: '2024-01-20T14:30:00.000Z',
                            updatedAt: '2024-05-15T18:20:00.000Z'
                        },
                        {
                            id: 'task_2024_004_04',
                            name: 'Restaurant and Bar Audio Zones',
                            description: 'Design and install multi-zone audio system for restaurants, bars, and common areas with individual volume control.',
                            status: 'completed',
                            priority: 'medium',
                            assignee: 'Lisa Chen',
                            estimatedHours: 64,
                            startDate: '2024-04-01',
                            endDate: '2024-05-20',
                            createdAt: '2024-01-20T14:45:00.000Z',
                            updatedAt: '2024-05-20T16:30:00.000Z'
                        },
                        {
                            id: 'task_2024_004_05',
                            name: 'Digital Signage Network',
                            description: 'Install and configure resort-wide digital signage network with content management system for events and promotions.',
                            status: 'completed',
                            priority: 'medium',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 56,
                            startDate: '2024-04-15',
                            endDate: '2024-06-05',
                            createdAt: '2024-01-20T15:00:00.000Z',
                            updatedAt: '2024-06-05T17:45:00.000Z'
                        },
                        {
                            id: 'task_2024_004_06',
                            name: 'System Integration and Programming',
                            description: 'Integrate all systems with central control, program user interfaces, and establish maintenance protocols.',
                            status: 'completed',
                            priority: 'critical',
                            assignee: 'Mike Davis',
                            estimatedHours: 72,
                            startDate: '2024-05-20',
                            endDate: '2024-06-20',
                            createdAt: '2024-01-20T15:15:00.000Z',
                            updatedAt: '2024-06-20T20:15:00.000Z'
                        },
                        {
                            id: 'task_2024_004_07',
                            name: 'Staff Training and Event Testing',
                            description: 'Train resort staff on all systems, conduct live event testing, and provide ongoing support documentation.',
                            status: 'completed',
                            priority: 'high',
                            assignee: 'Sarah Johnson',
                            estimatedHours: 40,
                            startDate: '2024-06-15',
                            endDate: '2024-06-28',
                            createdAt: '2024-01-20T15:30:00.000Z',
                            updatedAt: '2024-06-28T22:15:00.000Z'
                        }
                    ]
                }
            ]
        };

        // ==================== NAVIGATION MANAGEMENT ====================
        function showView(viewName) {
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`nav${viewName.charAt(0).toUpperCase() + viewName.slice(1)}`).classList.add('active');

            // Update content views
            document.querySelectorAll('.content-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(`${viewName}View`).classList.add('active');

            // Update breadcrumb
            updateBreadcrumb(viewName);
            
            // Update sidebar
            updateSidebar(viewName);
            
            // Load view content
            loadViewContent(viewName);
            
            AppState.currentView = viewName;
        }

        function updateBreadcrumb(viewName) {
            const breadcrumbMap = {
                dashboard: { root: 'Dashboard', current: 'Overview' },
                projects: { root: 'Projects', current: 'All Projects' },
                reports: { root: 'Reports', current: 'Analytics' },
                admin: { root: 'Administration', current: 'System Management' }
            };

            const breadcrumb = breadcrumbMap[viewName] || { root: 'Dashboard', current: 'Overview' };
            document.getElementById('breadcrumbRoot').textContent = breadcrumb.root;
            document.getElementById('breadcrumbCurrent').textContent = breadcrumb.current;
        }

        function updateSidebar(viewName) {
            const sidebarConfigs = {
                dashboard: {
                    title: 'Dashboard',
                    subtitle: 'Project overview and metrics',
                    nav: `
                        <div class="nav-section">
                            <div class="nav-section-title">Overview</div>
                            <button class="nav-item active" onclick="showDashboardTab('overview')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Key Metrics</span>
                            </button>
                            <button class="nav-item" onclick="showDashboardTab('trends')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Trends</span>
                            </button>
                            <button class="nav-item" onclick="showDashboardTab('alerts')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Alerts</span>
                                <span class="nav-item-badge">3</span>
                            </button>
                        </div>
                        <div class="nav-section">
                            <div class="nav-section-title">Quick Actions</div>
                            <button class="nav-item" onclick="showCreateProject()">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">New Project</span>
                            </button>
                            <button class="nav-item" onclick="exportDashboard()">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Export Report</span>
                            </button>
                        </div>
                    `
                },
                projects: {
                    title: 'Projects',
                    subtitle: 'Manage all AV projects',
                    nav: `
                        <div class="nav-section">
                            <div class="nav-section-title">Views</div>
                            <button class="nav-item active" onclick="showProjectsTab('list')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">List View</span>
                            </button>
                            <button class="nav-item" onclick="showProjectsTab('kanban')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Kanban Board</span>
                            </button>
                            <button class="nav-item" onclick="showProjectsTab('calendar')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Calendar View</span>
                            </button>
                        </div>
                        <div class="nav-section">
                            <div class="nav-section-title">Filters</div>
                            <button class="nav-item" onclick="filterProjects('active')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Active</span>
                                <span class="nav-item-badge" id="activeCount">0</span>
                            </button>
                            <button class="nav-item" onclick="filterProjects('completed')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Completed</span>
                                <span class="nav-item-badge" id="completedCount">0</span>
                            </button>
                            <button class="nav-item" onclick="filterProjects('overdue')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Overdue</span>
                                <span class="nav-item-badge" id="overdueCount">0</span>
                            </button>
                        </div>
                    `
                },
                reports: {
                    title: 'Reports & Analytics',
                    subtitle: 'Comprehensive insights',
                    nav: `
                        <div class="nav-section">
                            <div class="nav-section-title">Report Types</div>
                            <button class="nav-item active" onclick="showReportTab('executive')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Executive Summary</span>
                            </button>
                            <button class="nav-item" onclick="showReportTab('detailed')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Detailed Analytics</span>
                            </button>
                            <button class="nav-item" onclick="showReportTab('financial')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Financial Report</span>
                            </button>
                            <button class="nav-item" onclick="showReportTab('team')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Team Performance</span>
                            </button>
                        </div>
                        <div class="nav-section">
                            <div class="nav-section-title">Time Period</div>
                            <button class="nav-item" onclick="setReportPeriod('week')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">This Week</span>
                            </button>
                            <button class="nav-item" onclick="setReportPeriod('month')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">This Month</span>
                            </button>
                            <button class="nav-item" onclick="setReportPeriod('quarter')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">This Quarter</span>
                            </button>
                        </div>
                    `
                },
                admin: {
                    title: 'Administration',
                    subtitle: 'System management and configuration',
                    nav: `
                        <div class="nav-section">
                            <div class="nav-section-title">User Management</div>
                            <button class="nav-item active" onclick="showAdminTab('users')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Users</span>
                            </button>
                            <button class="nav-item" onclick="showAdminTab('roles')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Roles & Permissions</span>
                            </button>
                        </div>
                        <div class="nav-section">
                            <div class="nav-section-title">System</div>
                            <button class="nav-item" onclick="showAdminTab('settings')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Settings</span>
                            </button>
                            <button class="nav-item" onclick="showAdminTab('audit')">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Audit Log</span>
                            </button>
                        </div>
                        <div class="nav-section">
                            <div class="nav-section-title">Quick Actions</div>
                            <button class="nav-item" onclick="showCreateUser()">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Add User</span>
                            </button>
                            <button class="nav-item" onclick="exportUserData()">
                                <span class="nav-item-icon"></span>
                                <span class="nav-item-text">Export Users</span>
                            </button>
                        </div>
                    `
                }
            };

            const config = sidebarConfigs[viewName];
            document.getElementById('sidebarTitle').textContent = config.title;
            document.getElementById('sidebarSubtitle').textContent = config.subtitle;
            document.getElementById('sidebarNav').innerHTML = config.nav;
        }

        // ==================== CONTENT LOADING ====================
        function loadViewContent(viewName) {
            switch (viewName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'projects':
                    loadProjects();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'admin':
                    loadAdministration();
                    break;
            }
        }

        async function loadDashboard() {
            try {
                // Load dashboard metrics
                await loadDashboardMetrics();
                await loadDashboardCharts();
                await loadRecentProjects();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadDashboardMetrics() {
            // Demo data - replace with API call
            const metrics = [
                {
                    icon: '',
                    iconClass: 'primary',
                    value: '24',
                    label: 'Total Projects',
                    change: '+3 this month',
                    changeClass: 'positive'
                },
                {
                    icon: '',
                    iconClass: 'success',
                    value: '18',
                    label: 'Completed',
                    change: '+2 this week',
                    changeClass: 'positive'
                },
                {
                    icon: '',
                    iconClass: 'warning',
                    value: '4',
                    label: 'In Progress',
                    change: 'On track',
                    changeClass: 'neutral'
                },
                {
                    icon: '',
                    iconClass: 'danger',
                    value: '2',
                    label: 'At Risk',
                    change: '-1 resolved',
                    changeClass: 'positive'
                },
                {
                    icon: '',
                    iconClass: 'success',
                    value: '$2.4M',
                    label: 'Total Value',
                    change: '+12% vs last month',
                    changeClass: 'positive'
                },
                {
                    icon: '',
                    iconClass: 'primary',
                    value: '85%',
                    label: 'Team Utilization',
                    change: 'Optimal range',
                    changeClass: 'neutral'
                }
            ];

            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = metrics.map(metric => `
                <div class="metric-card fade-in">
                    <div class="metric-header">
                        <div class="metric-icon ${metric.iconClass}">${metric.icon}</div>
                    </div>
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-change ${metric.changeClass}">${metric.change}</div>
                </div>
            `).join('');
        }

        async function loadDashboardCharts() {
            // Load status distribution chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Completed', 'On Hold', 'Cancelled'],
                    datasets: [{
                        data: [6, 18, 2, 1],
                        backgroundColor: [
                            '#22c55e',
                            '#0ea5e9', 
                            '#f59e0b',
                            '#ef4444'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Load progress trends chart
            const progressCtx = document.getElementById('progressChart').getContext('2d');
            new Chart(progressCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Average Progress',
                        data: [45, 52, 61, 68, 73, 78],
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadRecentProjects() {
            // Use actual projects from AppState
            const projects = (AppState.projects || []).slice(0, 10); // Show up to 10 recent projects

            const tableBody = document.getElementById('recentProjectsTable');
            if (projects.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                            No projects available. <a href="#" onclick="showView('projects')" style="color: var(--primary-500);">Create your first project</a>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = projects.map(project => `
                <tr>
                    <td>${project.name || 'Unnamed Project'}</td>
                    <td>${project.requestorInfo ? project.requestorInfo.split(',')[0] : 'N/A'}</td>
                    <td>
                        <span class="status-badge ${project.status || 'draft'}">${formatStatus(project.status || 'draft')}</span>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="flex: 1; height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; background: var(--primary-500); width: ${project.progress || 0}%; transition: width 0.3s;"></div>
                            </div>
                            <span style="font-size: 0.75rem; color: var(--gray-600);">${project.progress || 0}%</span>
                        </div>
                    </td>
                    <td>${formatDate(project.endDate || project.dueDate)}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="viewProject('${project.id}')">
                            View
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadProjects() {
            document.getElementById('projectsContent').innerHTML = `
                <div class="projects-container">
                    <div class="projects-header">
                        <h3>Project Management</h3>
                        <div class="projects-controls">
                            <button class="btn btn-primary" onclick="showCreateProject()">
                                 New Project
                            </button>
                            <button class="btn btn-secondary" onclick="refreshProjects()">
                                 Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Search & Filtering System -->
                    <div class="advanced-search-container">
                        <!-- Quick Search Bar -->
                        <div class="quick-search-row">
                            <div class="search-input-container">
                                <input type="text" id="globalProjectSearch" placeholder="Search by name, client, location, or description..." 
                                       oninput="performAdvancedSearch()" class="global-search-input">
                                <span class="search-icon"></span>
                            </div>
                            <button class="btn btn-secondary" onclick="toggleAdvancedFilters()" id="advancedFilterToggle">
                                 Advanced Filters
                            </button>
                            <button class="btn btn-outline" onclick="clearAllFilters()">
                                 Clear All
                            </button>
                        </div>

                        <!-- Advanced Filters Panel (Initially Hidden) -->
                        <div class="advanced-filters-panel" id="advancedFiltersPanel" style="display: none;">
                            <div class="filters-grid">
                                <!-- Status & Progress Filters -->
                                <div class="filter-group">
                                    <label class="filter-label">Project Status</label>
                                    <div class="filter-checkboxes" id="statusFilters">
                                        <label><input type="checkbox" value="active" onchange="performAdvancedSearch()">  Active</label>
                                        <label><input type="checkbox" value="completed" onchange="performAdvancedSearch()">  Completed</label>
                                        <label><input type="checkbox" value="on-hold" onchange="performAdvancedSearch()">  On Hold</label>
                                        <label><input type="checkbox" value="draft" onchange="performAdvancedSearch()">  Draft</label>
                                        <label><input type="checkbox" value="cancelled" onchange="performAdvancedSearch()">  Cancelled</label>
                                    </div>
                                </div>

                                <!-- Business Line Filter -->
                                <div class="filter-group">
                                    <label class="filter-label">Business Line</label>
                                    <div class="filter-checkboxes" id="businessLineFilters">
                                        <label><input type="checkbox" value="corporate" onchange="performAdvancedSearch()">  Corporate</label>
                                        <label><input type="checkbox" value="education" onchange="performAdvancedSearch()">  Education</label>
                                        <label><input type="checkbox" value="healthcare" onchange="performAdvancedSearch()">  Healthcare</label>
                                        <label><input type="checkbox" value="retail" onchange="performAdvancedSearch()">  Retail</label>
                                        <label><input type="checkbox" value="hospitality" onchange="performAdvancedSearch()">  Hospitality</label>
                                    </div>
                                </div>

                                <!-- Project Type Filter -->
                                <div class="filter-group">
                                    <label class="filter-label">Project Type</label>
                                    <div class="filter-checkboxes" id="projectTypeFilters">
                                        <label><input type="checkbox" value="new-build" onchange="performAdvancedSearch()">  New Build</label>
                                        <label><input type="checkbox" value="upgrade" onchange="performAdvancedSearch()">  Upgrade</label>
                                        <label><input type="checkbox" value="breakfix" onchange="performAdvancedSearch()">  Break/Fix</label>
                                        <label><input type="checkbox" value="custom" onchange="performAdvancedSearch()">  Custom</label>
                                    </div>
                                </div>

                                <!-- Priority Filter -->
                                <div class="filter-group">
                                    <label class="filter-label">Priority</label>
                                    <div class="filter-checkboxes" id="priorityFilters">
                                        <label><input type="checkbox" value="critical" onchange="performAdvancedSearch()">  Critical</label>
                                        <label><input type="checkbox" value="high" onchange="performAdvancedSearch()">  High</label>
                                        <label><input type="checkbox" value="medium" onchange="performAdvancedSearch()">  Medium</label>
                                        <label><input type="checkbox" value="low" onchange="performAdvancedSearch()">  Low</label>
                                    </div>
                                </div>

                                <!-- Date Range Filters -->
                                <div class="filter-group">
                                    <label class="filter-label">Date Filters</label>
                                    <div class="date-filters">
                                        <label>Start Date:</label>
                                        <input type="date" id="startDateFilter" onchange="performAdvancedSearch()">
                                        <label>End Date:</label>
                                        <input type="date" id="endDateFilter" onchange="performAdvancedSearch()">
                                    </div>
                                </div>

                                <!-- Budget Range Filter -->
                                <div class="filter-group">
                                    <label class="filter-label">Budget Range</label>
                                    <div class="budget-filters">
                                        <input type="number" id="minBudgetFilter" placeholder="Min Budget" onchange="performAdvancedSearch()">
                                        <input type="number" id="maxBudgetFilter" placeholder="Max Budget" onchange="performAdvancedSearch()">
                                    </div>
                                </div>

                                <!-- Progress Range Filter -->
                                <div class="filter-group">
                                    <label class="filter-label">Progress Range (%)</label>
                                    <div class="progress-filters">
                                        <input type="range" id="minProgressFilter" min="0" max="100" value="0" onchange="performAdvancedSearch()">
                                        <span id="minProgressValue">0%</span>
                                        <input type="range" id="maxProgressFilter" min="0" max="100" value="100" onchange="performAdvancedSearch()">
                                        <span id="maxProgressValue">100%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Filter Presets -->
                            <div class="quick-presets">
                                <label class="filter-label">Quick Filters:</label>
                                <div class="preset-buttons">
                                    <button class="btn btn-sm btn-outline" onclick="applyPreset('overdue')"> Overdue Projects</button>
                                    <button class="btn btn-sm btn-outline" onclick="applyPreset('active-high')"> Active High Priority</button>
                                    <button class="btn btn-sm btn-outline" onclick="applyPreset('near-completion')"> Near Completion</button>
                                    <button class="btn btn-sm btn-outline" onclick="applyPreset('budget-exceeded')"> Budget Issues</button>
                                    <button class="btn btn-sm btn-outline" onclick="applyPreset('this-month')"> Due This Month</button>
                                </div>
                            </div>
                        </div>

                        <!-- Results Summary & Controls -->
                        <div class="search-results-header">
                            <div class="results-info">
                                <span id="searchResultsCount">0 projects found</span>
                                <span id="activeFiltersCount" style="display: none;"> <span class="filter-count">0</span> filters active</span>
                            </div>
                            <div class="results-controls">
                                <label>Sort by:</label>
                                <select id="sortByField" onchange="performAdvancedSearch()">
                                    <option value="name">Project Name</option>
                                    <option value="status">Status</option>
                                    <option value="progress">Progress</option>
                                    <option value="dueDate">Due Date</option>
                                    <option value="startDate">Start Date</option>
                                    <option value="estimatedBudget">Budget</option>
                                    <option value="businessLine">Business Line</option>
                                    <option value="priority">Priority</option>
                                </select>
                                <select id="sortDirection" onchange="performAdvancedSearch()">
                                    <option value="asc"> Ascending</option>
                                    <option value="desc"> Descending</option>
                                </select>
                                <label>Show:</label>
                                <select id="pageSize" onchange="performAdvancedSearch()">
                                    <option value="25">25 per page</option>
                                    <option value="50">50 per page</option>
                                    <option value="100">100 per page</option>
                                    <option value="all">All projects</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="projects-grid" id="projectsGrid">
                        <div class="loading-state">Loading projects...</div>
                    </div>
                </div>
            `;

            // Initialize advanced search system
            setTimeout(() => {
                performAdvancedSearch();
            }, 100);
        }

        async function loadReports() {
            document.getElementById('reportsContent').innerHTML = `
                <div class="reports-container">
                    <div class="reports-header">
                        <h3>Project Analytics & Reports</h3>
                        <div class="report-controls">
                            <select id="reportPeriod" class="form-select">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                            </select>
                            <div class="report-tabs">
                                <button class="tab-btn active" onclick="showReportType('analytics')">Analytics</button>
                                <button class="tab-btn" onclick="showReportType('executive')" id="executiveTab">Executive</button>
                            </div>
                            <button class="btn btn-primary" onclick="exportReport()">
                                 Export Report
                            </button>
                        </div>
                    </div>

                    <!-- Analytics View (default) -->
                    <div id="analyticsView" class="report-view">
                        <div class="charts-grid">
                            <!-- Performance Overview -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <h4>Project Performance Trends</h4>
                                <div class="chart-controls">
                                    <button class="chart-toggle active" onclick="switchPerformanceChart('progress')">Progress</button>
                                    <button class="chart-toggle" onclick="switchPerformanceChart('budget')">Budget</button>
                                    <button class="chart-toggle" onclick="switchPerformanceChart('timeline')">Timeline</button>
                                </div>
                            </div>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>

                        <!-- RAG Status Distribution -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <h4>Project Health Status (RAG)</h4>
                                <p class="chart-subtitle">Red = Critical Issues | Yellow = At Risk | Green = On Track</p>
                            </div>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="statusDistributionChart"></canvas>
                            </div>
                        </div>

                        <!-- Task RAG Status -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <h4>Task Health Status (RAG)</h4>
                                <p class="chart-subtitle">Individual task status across all projects</p>
                            </div>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="taskRAGChart"></canvas>
                            </div>
                        </div>

                        <!-- Budget Variance Analysis -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <h4>Budget Variance Analysis</h4>
                                <p class="chart-subtitle">Estimated vs Actual Budget by Project</p>
                            </div>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="budgetAnalysisChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Tables -->
                    <div class="report-tables">
                        <div class="report-section">
                            <h4>Project Performance Summary</h4>
                            <div class="table-container">
                                <table class="report-table" id="projectSummaryTable">
                                    <thead>
                                        <tr>
                                            <th>Project</th>
                                            <th>RAG Status</th>
                                            <th>Progress</th>
                                            <th>Budget Variance</th>
                                            <th>Timeline Status</th>
                                            <th>Deliverables</th>
                                        </tr>
                                    </thead>
                                    <tbody id="projectSummaryBody">
                                        <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    </div>

                    <!-- Executive Summary View -->
                    <div id="executiveView" class="report-view" style="display: none;">
                        <div class="executive-summary-container">
                            <!-- KPI Dashboard -->
                            <div class="kpi-grid">
                                <div class="kpi-card">
                                    <div class="kpi-value" id="kpi-projects">--</div>
                                    <div class="kpi-label">Total Projects</div>
                                    <div class="kpi-trend" id="kpi-projects-trend"></div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-value" id="kpi-completion">--%</div>
                                    <div class="kpi-label">Completion Rate</div>
                                    <div class="kpi-trend" id="kpi-completion-trend"></div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-value" id="kpi-budget">--</div>
                                    <div class="kpi-label">Projects On Budget</div>
                                    <div class="kpi-trend" id="kpi-budget-trend"></div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-value" id="kpi-risk">--</div>
                                    <div class="kpi-label">Risk Level</div>
                                    <div class="kpi-trend" id="kpi-risk-trend"></div>
                                </div>
                            </div>

                            <!-- Strategic Insights -->
                            <div class="executive-section">
                                <h4>Strategic Insights</h4>
                                <div id="strategicInsights" class="insights-container">
                                    <div class="insight-placeholder">Loading insights...</div>
                                </div>
                            </div>

                            <!-- Critical Projects -->
                            <div class="executive-section">
                                <h4>Critical Projects Requiring Attention</h4>
                                <div id="criticalProjects" class="critical-projects-list">
                                    <div class="insight-placeholder">Loading critical projects...</div>
                                </div>
                            </div>

                            <!-- Financial Overview -->
                            <div class="executive-section">
                                <h4>Financial Overview</h4>
                                <div class="financial-grid">
                                    <div class="financial-metric">
                                        <div class="financial-label">Total Budget</div>
                                        <div class="financial-value" id="exec-total-budget">$--</div>
                                    </div>
                                    <div class="financial-metric">
                                        <div class="financial-label">Spent</div>
                                        <div class="financial-value" id="exec-spent-budget">$--</div>
                                    </div>
                                    <div class="financial-metric">
                                        <div class="financial-label">Remaining</div>
                                        <div class="financial-value" id="exec-remaining-budget">$--</div>
                                    </div>
                                    <div class="financial-metric">
                                        <div class="financial-label">Variance</div>
                                        <div class="financial-value" id="exec-budget-util">--%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Initialize with analytics view
            setTimeout(async () => {
                await showReportType('analytics');
            }, 100);
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatStatus(status) {
            return status.charAt(0).toUpperCase() + status.slice(1).replace('-', ' ');
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        function formatProjectType(type) {
            const typeMap = {
                'new-build': 'New Build',
                'upgrade': 'Upgrade',
                'breakfix': 'BreakFix',
                'custom': 'Custom Project'
            };
            return typeMap[type] || type;
        }

        function formatBusinessLine(businessLine) {
            if (!businessLine) return 'N/A';
            return businessLine.charAt(0).toUpperCase() + businessLine.slice(1);
        }

        function refreshDashboard() {
            const button = event.target;
            button.classList.add('loading');
            setTimeout(() => {
                loadDashboard();
                button.classList.remove('loading');
            }, 1000);
        }

        // ==================== PROJECT MANAGEMENT FUNCTIONS ====================
        let currentProjects = [];
        let filteredProjects = [];

        async function renderProjectsGrid() {
            try {
                // Use AppState projects directly (demo mode)
                currentProjects = AppState.projects || [];
                console.log(' DEBUG: Found', currentProjects.length, 'projects in AppState');
                console.log(' DEBUG: First project:', currentProjects[0]?.name || 'none');
                
                filteredProjects = [...currentProjects];
                displayProjects(filteredProjects);
                
            } catch (error) {
                console.error('Error loading projects:', error);
                showNotification('Failed to load projects', 'error');
            }
        }

        function displayProjects(projects) {
            const projectsGrid = document.getElementById('projectsGrid');
            
            if (projects.length === 0) {
                projectsGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <h3>No Projects Found</h3>
                        <p>Create your first project to get started</p>
                        <button class="btn btn-primary" onclick="showCreateProject()">
                             Create Project
                        </button>
                    </div>
                `;
                return;
            }

            projectsGrid.innerHTML = projects.map(project => {
                const progressColor = project.progress > 75 ? '#22c55e' : 
                                    project.progress > 50 ? '#0ea5e9' :
                                    project.progress > 25 ? '#f59e0b' : '#ef4444';

                const isOverdue = project.endDate && new Date(project.endDate) < new Date() && project.status !== 'completed';
                const daysRemaining = project.endDate ? Math.ceil((new Date(project.endDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;

                return `
                    <div class="project-card ${isOverdue ? 'overdue' : ''}" onclick="viewProject('${project.id}')">
                        <div class="project-card-header">
                            <h4 class="project-title">${project.name}</h4>
                            <div class="project-menu">
                                <button class="menu-btn" onclick="event.stopPropagation(); showProjectMenu('${project.id}')"></button>
                            </div>
                        </div>
                        
                        <div class="project-meta">
                            <span class="status-badge ${project.status}">${formatStatus(project.status)}</span>
                            <span class="project-type">${formatProjectType(project.type)}</span>
                        </div>
                        
                        <div class="project-details">
                            <div class="project-detail-item">
                                <span class="detail-label"> Requestor:</span>
                                <span class="detail-value">${project.requestorInfo ? project.requestorInfo.split(',')[0] : 'N/A'}</span>
                            </div>
                            <div class="project-detail-item">
                                <span class="detail-label"> Location:</span>
                                <span class="detail-value">${project.siteLocation || 'N/A'}</span>
                            </div>
                            <div class="project-detail-item">
                                <span class="detail-label"> Business:</span>
                                <span class="detail-value">${formatBusinessLine(project.businessLine)}</span>
                            </div>
                        </div>
                        
                        <div class="project-progress">
                            <div class="progress-header">
                                <span>Progress</span>
                                <span>${project.progress}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${project.progress}%; background: ${progressColor};"></div>
                            </div>
                        </div>
                        
                        <div class="project-stats">
                            <div class="stat">
                                <span class="stat-label">Tasks</span>
                                <span class="stat-value">${project.tasks ? project.tasks.filter(t => t.status === 'completed').length : 0}/${project.tasks ? project.tasks.length : 0}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Budget</span>
                                <span class="stat-value">$${(project.estimatedBudget || 0).toLocaleString()}</span>
                            </div>
                        </div>
                        
                        <div class="project-timeline">
                            ${project.endDate ? `
                                <div class="timeline-item ${isOverdue ? 'overdue' : daysRemaining <= 7 ? 'due-soon' : ''}">
                                     ${isOverdue ? `${Math.abs(daysRemaining)} days overdue` : 
                                          daysRemaining <= 0 ? 'Due today' :
                                          `${daysRemaining} days left`}
                                </div>
                            ` : '<div class="timeline-item"> No deadline set</div>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderListView(projects) {
            const projectsGrid = document.getElementById('projectsGrid');
            
            if (projects.length === 0) {
                projectsGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <h3>No Projects Found</h3>
                        <p>No projects match the current filter</p>
                        <button class="btn btn-primary" onclick="showCreateProject()">
                             Create Project
                        </button>
                    </div>
                `;
                return;
            }

            // Use the existing displayProjects function logic but with custom container
            displayProjects(projects);
        }

        function renderKanbanView(projects) {
            const projectsGrid = document.getElementById('projectsGrid');
            
            // Simplified grouping - In Progress (active/draft), On Hold, and Completed
            const columns = {
                'in-progress': projects.filter(p => p.status === 'active' || p.status === 'draft' || p.status === 'not-started'),
                'on-hold': projects.filter(p => p.status === 'on-hold'),
                'completed': projects.filter(p => p.status === 'completed' || p.status === 'cancelled')
            };

            const columnConfig = {
                'in-progress': { 
                    title: 'In Progress', 
                    icon: '', 
                    color: 'active',
                    description: 'Active and upcoming projects'
                },
                'on-hold': { 
                    title: 'On Hold', 
                    icon: '', 
                    color: 'on-hold',
                    description: 'Paused projects awaiting action'
                },
                'completed': { 
                    title: 'Completed', 
                    icon: '', 
                    color: 'completed',
                    description: 'Finished and closed projects'
                }
            };

            projectsGrid.innerHTML = `
                <div class="kanban-board">
                    ${Object.entries(columns).map(([status, statusProjects]) => {
                        const config = columnConfig[status];
                        return `
                            <div class="kanban-column" data-status="${status}">
                                <div class="kanban-column-header">
                                    <div class="kanban-column-title">
                                        <span style="font-size: 1.25rem; margin-right: 0.5rem;">${config.icon}</span>
                                        <div>
                                            <div style="font-weight: 600; color: var(--gray-900);">${config.title}</div>
                                            <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 2px;">${config.description}</div>
                                        </div>
                                    </div>
                                    <span class="kanban-count">${statusProjects.length}</span>
                                </div>
                                <div class="kanban-projects">
                                    ${statusProjects.length > 0 ? statusProjects.map(project => {
                                        const priorityColors = {
                                            'critical': 'var(--danger-500)',
                                            'high': 'var(--warning-500)',
                                            'medium': 'var(--primary-500)',
                                            'low': 'var(--gray-400)'
                                        };
                                        const priorityColor = priorityColors[project.priority] || 'var(--gray-400)';
                                        
                                        return `
                                        <div class="kanban-project" onclick="viewProject('${project.id}')">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                                <div class="kanban-project-title" style="flex: 1; margin-right: 0.5rem;">${project.name}</div>
                                                <div style="width: 4px; height: 24px; background: ${priorityColor}; border-radius: 2px;" title="Priority: ${project.priority || 'normal'}"></div>
                                            </div>
                                            
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem;">
                                                <div class="kanban-project-meta">
                                                    <span style="color: var(--gray-500); font-size: 0.7rem;">TYPE</span><br>
                                                    <span style="font-size: 0.8rem; font-weight: 500;">${formatProjectType(project.type)}</span>
                                                </div>
                                                <div class="kanban-project-meta">
                                                    <span style="color: var(--gray-500); font-size: 0.7rem;">DUE</span><br>
                                                    <span style="font-size: 0.8rem; font-weight: 500;">${project.endDate ? formatDate(project.endDate) : 'No date'}</span>
                                                </div>
                                            </div>
                                            
                                            <div style="border-top: 1px solid var(--gray-100); padding-top: 0.75rem;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-size: 0.75rem; color: var(--gray-600);">Progress</span>
                                                    <span style="font-size: 0.875rem; font-weight: 600; color: var(--gray-900);">${project.progress || 0}%</span>
                                                </div>
                                                <div class="kanban-progress-bar" style="margin-top: 0.375rem;">
                                                    <div class="kanban-progress-fill" style="width: ${project.progress || 0}%"></div>
                                                </div>
                                            </div>
                                        </div>`;
                                    }).join('') : `
                                        <div class="kanban-empty">
                                            <div class="kanban-empty-icon"></div>
                                            <div>No ${config.title.toLowerCase()} projects</div>
                                        </div>
                                    `}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderCalendarView(projects) {
            const projectsGrid = document.getElementById('projectsGrid');
            
            // Create a simple calendar view showing projects by month
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            // Get projects with dates
            const projectsWithDates = projects.filter(p => p.startDate || p.dueDate || p.endDate);
            
            // Group projects by month
            const monthlyProjects = {};
            
            projectsWithDates.forEach(project => {
                const dates = [project.startDate, project.dueDate, project.endDate].filter(Boolean);
                dates.forEach(dateStr => {
                    const date = new Date(dateStr);
                    const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                    if (!monthlyProjects[monthKey]) {
                        monthlyProjects[monthKey] = [];
                    }
                    if (!monthlyProjects[monthKey].find(p => p.id === project.id)) {
                        monthlyProjects[monthKey].push(project);
                    }
                });
            });

            // Generate calendar for current and next 2 months
            const months = [];
            for (let i = -1; i <= 2; i++) {
                const monthDate = new Date(currentYear, currentMonth + i, 1);
                const monthKey = `${monthDate.getFullYear()}-${monthDate.getMonth()}`;
                const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                months.push({
                    key: monthKey,
                    name: monthName,
                    projects: monthlyProjects[monthKey] || []
                });
            }

            projectsGrid.innerHTML = `
                <div class="calendar-view">
                    ${months.map(month => `
                        <div class="calendar-month">
                            <div class="calendar-month-header">
                                <h4> ${month.name}</h4>
                                <span class="project-count">${month.projects.length} projects</span>
                            </div>
                            <div class="calendar-projects">
                                ${month.projects.length > 0 ? month.projects.map(project => `
                                    <div class="calendar-item" onclick="viewProject('${project.id}')">
                                        <div class="calendar-item-header">
                                            <h5>${project.name}</h5>
                                            <span class="status-badge ${project.status}">${formatStatus(project.status)}</span>
                                        </div>
                                        <div class="calendar-item-details">
                                            ${project.startDate ? `<div> Start: ${formatDate(project.startDate)}</div>` : ''}
                                            ${project.dueDate ? `<div> Due: ${formatDate(project.dueDate)}</div>` : ''}
                                            ${project.endDate ? `<div> End: ${formatDate(project.endDate)}</div>` : ''}
                                        </div>
                                        <div class="progress-bar small">
                                            <div class="progress-fill" style="width: ${project.progress || 0}%"></div>
                                            <span class="progress-text">${project.progress || 0}%</span>
                                        </div>
                                    </div>
                                `).join('') : '<p class="no-projects">No projects scheduled</p>'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateProjectCounts() {
            const projects = AppState.projects || [];
            const activeCount = projects.filter(p => p.status === 'active').length;
            const completedCount = projects.filter(p => p.status === 'completed').length;
            const overdueCount = projects.filter(p => {
                const dueDate = p.dueDate || p.endDate;
                return dueDate && new Date(dueDate) < new Date() && p.status !== 'completed';
            }).length;

            // Update sidebar badges
            const activeCountEl = document.getElementById('activeCount');
            const completedCountEl = document.getElementById('completedCount');
            const overdueCountEl = document.getElementById('overdueCount');

            if (activeCountEl) activeCountEl.textContent = activeCount;
            if (completedCountEl) completedCountEl.textContent = completedCount;
            if (overdueCountEl) overdueCountEl.textContent = overdueCount;
        }

        function filterProjects(filter) {
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Update current filter state
            currentProjectFilter = filter;

            // Use the new rendering system
            renderProjectView(currentProjectView, currentProjectFilter);
            
            // Update counts
            updateProjectCounts();
        }

        // Advanced Search System Variables
        let currentSearchResults = [];
        let currentPage = 1;
        let isAdvancedFiltersVisible = false;

        function performAdvancedSearch() {
            const searchTerm = document.getElementById('globalProjectSearch')?.value.toLowerCase() || '';
            const allProjects = AppState.projects || [];
            
            // Apply text search first
            let filtered = allProjects.filter(project => 
                project.name?.toLowerCase().includes(searchTerm) ||
                project.requestorInfo?.toLowerCase().includes(searchTerm) ||
                project.siteLocation?.toLowerCase().includes(searchTerm) ||
                project.businessLine?.toLowerCase().includes(searchTerm) ||
                project.description?.toLowerCase().includes(searchTerm) ||
                project.type?.toLowerCase().includes(searchTerm) ||
                project.priority?.toLowerCase().includes(searchTerm)
            );

            // Apply status filters
            const statusFilters = Array.from(document.querySelectorAll('#statusFilters input:checked')).map(cb => cb.value);
            if (statusFilters.length > 0) {
                filtered = filtered.filter(project => statusFilters.includes(project.status));
            }

            // Apply business line filters
            const businessLineFilters = Array.from(document.querySelectorAll('#businessLineFilters input:checked')).map(cb => cb.value);
            if (businessLineFilters.length > 0) {
                filtered = filtered.filter(project => businessLineFilters.includes(project.businessLine));
            }

            // Apply project type filters
            const typeFilters = Array.from(document.querySelectorAll('#projectTypeFilters input:checked')).map(cb => cb.value);
            if (typeFilters.length > 0) {
                filtered = filtered.filter(project => typeFilters.includes(project.type));
            }

            // Apply priority filters
            const priorityFilters = Array.from(document.querySelectorAll('#priorityFilters input:checked')).map(cb => cb.value);
            if (priorityFilters.length > 0) {
                filtered = filtered.filter(project => priorityFilters.includes(project.priority));
            }

            // Apply date filters
            const startDateFilter = document.getElementById('startDateFilter')?.value;
            const endDateFilter = document.getElementById('endDateFilter')?.value;
            if (startDateFilter) {
                filtered = filtered.filter(project => {
                    const projectStartDate = project.startDate || project.createdAt;
                    return projectStartDate && new Date(projectStartDate) >= new Date(startDateFilter);
                });
            }
            if (endDateFilter) {
                filtered = filtered.filter(project => {
                    const projectEndDate = project.endDate || project.dueDate;
                    return projectEndDate && new Date(projectEndDate) <= new Date(endDateFilter);
                });
            }

            // Apply budget filters
            const minBudget = parseFloat(document.getElementById('minBudgetFilter')?.value) || 0;
            const maxBudget = parseFloat(document.getElementById('maxBudgetFilter')?.value) || Infinity;
            filtered = filtered.filter(project => {
                const budget = project.estimatedBudget || 0;
                return budget >= minBudget && budget <= maxBudget;
            });

            // Apply progress filters
            const minProgress = parseInt(document.getElementById('minProgressFilter')?.value) || 0;
            const maxProgress = parseInt(document.getElementById('maxProgressFilter')?.value) || 100;
            filtered = filtered.filter(project => {
                const progress = project.progress || 0;
                return progress >= minProgress && progress <= maxProgress;
            });

            // Update progress slider displays
            const minProgressValue = document.getElementById('minProgressValue');
            const maxProgressValue = document.getElementById('maxProgressValue');
            if (minProgressValue) minProgressValue.textContent = minProgress + '%';
            if (maxProgressValue) maxProgressValue.textContent = maxProgress + '%';

            // Apply sorting
            const sortField = document.getElementById('sortByField')?.value || 'name';
            const sortDirection = document.getElementById('sortDirection')?.value || 'asc';
            filtered.sort((a, b) => {
                let aVal = a[sortField] || '';
                let bVal = b[sortField] || '';
                
                // Handle different data types
                if (sortField === 'progress' || sortField === 'estimatedBudget') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else if (sortField.includes('Date')) {
                    aVal = new Date(aVal || '1900-01-01');
                    bVal = new Date(bVal || '1900-01-01');
                } else {
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                }
                
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Store results and update UI
            currentSearchResults = filtered;
            updateSearchResultsDisplay();
            displaySearchResults();
        }

        function updateSearchResultsDisplay() {
            const resultsCount = document.getElementById('searchResultsCount');
            const activeFiltersCount = document.getElementById('activeFiltersCount');
            
            if (resultsCount) {
                const totalResults = currentSearchResults.length;
                resultsCount.textContent = `${totalResults} project${totalResults === 1 ? '' : 's'} found`;
            }

            // Count active filters
            const activeFilters = countActiveFilters();
            if (activeFiltersCount) {
                if (activeFilters > 0) {
                    activeFiltersCount.style.display = 'inline';
                    activeFiltersCount.querySelector('.filter-count').textContent = activeFilters;
                } else {
                    activeFiltersCount.style.display = 'none';
                }
            }
        }

        function countActiveFilters() {
            let count = 0;
            
            // Text search
            if (document.getElementById('globalProjectSearch')?.value.trim()) count++;
            
            // Checkbox filters
            count += document.querySelectorAll('#statusFilters input:checked').length;
            count += document.querySelectorAll('#businessLineFilters input:checked').length;
            count += document.querySelectorAll('#projectTypeFilters input:checked').length;
            count += document.querySelectorAll('#priorityFilters input:checked').length;
            
            // Date filters
            if (document.getElementById('startDateFilter')?.value) count++;
            if (document.getElementById('endDateFilter')?.value) count++;
            
            // Budget filters
            if (document.getElementById('minBudgetFilter')?.value) count++;
            if (document.getElementById('maxBudgetFilter')?.value) count++;
            
            // Progress filters (only count if not at default 0-100)
            const minProgress = parseInt(document.getElementById('minProgressFilter')?.value) || 0;
            const maxProgress = parseInt(document.getElementById('maxProgressFilter')?.value) || 100;
            if (minProgress > 0 || maxProgress < 100) count++;
            
            return count;
        }

        function displaySearchResults() {
            const pageSize = document.getElementById('pageSize')?.value || '25';
            let resultsToShow = currentSearchResults;
            
            // Apply pagination
            if (pageSize !== 'all') {
                const size = parseInt(pageSize);
                const startIndex = (currentPage - 1) * size;
                resultsToShow = currentSearchResults.slice(startIndex, startIndex + size);
            }
            
            // Update the view based on current project view mode
            const currentView = currentProjectView || 'list';
            switch(currentView) {
                case 'kanban':
                    renderKanbanView(resultsToShow);
                    break;
                case 'calendar':
                    renderCalendarView(resultsToShow);
                    break;
                default:
                    displayProjects(resultsToShow);
            }
        }

        function toggleAdvancedFilters() {
            const panel = document.getElementById('advancedFiltersPanel');
            const button = document.getElementById('advancedFilterToggle');
            
            isAdvancedFiltersVisible = !isAdvancedFiltersVisible;
            
            if (panel) {
                panel.style.display = isAdvancedFiltersVisible ? 'block' : 'none';
            }
            
            if (button) {
                button.textContent = isAdvancedFiltersVisible ? ' Hide Filters' : ' Advanced Filters';
            }
        }

        function clearAllFilters() {
            // Clear text search
            const searchInput = document.getElementById('globalProjectSearch');
            if (searchInput) searchInput.value = '';
            
            // Clear all checkboxes
            document.querySelectorAll('.advanced-filters-panel input[type="checkbox"]').forEach(cb => cb.checked = false);
            
            // Clear date filters
            const startDateFilter = document.getElementById('startDateFilter');
            const endDateFilter = document.getElementById('endDateFilter');
            if (startDateFilter) startDateFilter.value = '';
            if (endDateFilter) endDateFilter.value = '';
            
            // Clear budget filters
            const minBudgetFilter = document.getElementById('minBudgetFilter');
            const maxBudgetFilter = document.getElementById('maxBudgetFilter');
            if (minBudgetFilter) minBudgetFilter.value = '';
            if (maxBudgetFilter) maxBudgetFilter.value = '';
            
            // Reset progress sliders
            const minProgressFilter = document.getElementById('minProgressFilter');
            const maxProgressFilter = document.getElementById('maxProgressFilter');
            if (minProgressFilter) minProgressFilter.value = 0;
            if (maxProgressFilter) maxProgressFilter.value = 100;
            
            // Reset sort controls
            const sortByField = document.getElementById('sortByField');
            const sortDirection = document.getElementById('sortDirection');
            if (sortByField) sortByField.value = 'name';
            if (sortDirection) sortDirection.value = 'asc';
            
            // Perform fresh search
            performAdvancedSearch();
        }

        function applyPreset(presetName) {
            // Clear existing filters first
            clearAllFilters();
            
            const currentDate = new Date();
            const nextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, currentDate.getDate());
            
            switch(presetName) {
                case 'overdue':
                    // Show overdue projects
                    document.querySelector('#statusFilters input[value="active"]').checked = true;
                    document.getElementById('endDateFilter').value = currentDate.toISOString().split('T')[0];
                    document.getElementById('sortByField').value = 'dueDate';
                    break;
                    
                case 'active-high':
                    // Show active high priority projects
                    document.querySelector('#statusFilters input[value="active"]').checked = true;
                    document.querySelector('#priorityFilters input[value="high"]').checked = true;
                    document.querySelector('#priorityFilters input[value="critical"]').checked = true;
                    document.getElementById('sortByField').value = 'priority';
                    break;
                    
                case 'near-completion':
                    // Show projects 80%+ complete
                    document.querySelector('#statusFilters input[value="active"]').checked = true;
                    document.getElementById('minProgressFilter').value = 80;
                    document.getElementById('sortByField').value = 'progress';
                    document.getElementById('sortDirection').value = 'desc';
                    break;
                    
                case 'budget-exceeded':
                    // This would need custom logic to compare actual vs estimated budget
                    document.querySelector('#statusFilters input[value="active"]').checked = true;
                    document.getElementById('sortByField').value = 'estimatedBudget';
                    document.getElementById('sortDirection').value = 'desc';
                    break;
                    
                case 'this-month':
                    // Show projects due this month
                    const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                    const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                    document.getElementById('startDateFilter').value = startOfMonth.toISOString().split('T')[0];
                    document.getElementById('endDateFilter').value = endOfMonth.toISOString().split('T')[0];
                    document.getElementById('sortByField').value = 'dueDate';
                    break;
            }
            
            // Apply the preset
            performAdvancedSearch();
            
            // Show advanced filters panel if preset was applied
            if (!isAdvancedFiltersVisible) {
                toggleAdvancedFilters();
            }
        }

        function searchProjects() {
            // Legacy function - redirect to new advanced search
            performAdvancedSearch();
        }

        function refreshProjects() {
            const refreshBtn = event.target;
            refreshBtn.innerHTML = ' Refreshing...';
            refreshBtn.disabled = true;
            
            setTimeout(async () => {
                await renderProjectsGrid();
                refreshBtn.innerHTML = ' Refresh';
                refreshBtn.disabled = false;
                showNotification('Projects refreshed successfully!', 'success');
            }, 1000);
        }

        function showCreateProject() {
            const modal = document.createElement('div');
            modal.className = 'project-modal-overlay';
            modal.innerHTML = `
                <div class="project-modal">
                    <div class="modal-header">
                        <h3>Create New Project</h3>
                        <button class="close-btn" onclick="this.closest('.project-modal-overlay').remove()"></button>
                    </div>
                    <form class="modal-body" onsubmit="createProject(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="projectName">Project Name *</label>
                                <input type="text" id="projectName" name="name" required>
                            </div>
                            <div class="form-group">
                                <label for="requestorInfo">Requestor Information *</label>
                                <input type="text" id="requestorInfo" name="requestorInfo" placeholder="Name, Company, Contact" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="siteLocation">Site/Location *</label>
                                <input type="text" id="siteLocation" name="siteLocation" placeholder="Address or Site Name" required>
                            </div>
                            <div class="form-group">
                                <label for="businessLine">Business Line *</label>
                                <select id="businessLine" name="businessLine" required>
                                    <option value="">Select Business Line</option>
                                    <option value="corporate">Corporate</option>
                                    <option value="education">Education</option>
                                    <option value="healthcare">Healthcare</option>
                                    <option value="retail">Retail</option>
                                    <option value="hospitality">Hospitality</option>
                                    <option value="government">Government</option>
                                    <option value="residential">Residential</option>
                                    <option value="entertainment">Entertainment</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="projectDescription">Project Description</label>
                            <textarea id="projectDescription" name="description" rows="3" placeholder="Detailed project requirements and scope"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="projectType">Project Type *</label>
                                <select id="projectType" name="type" required>
                                    <option value="">Select Project Type</option>
                                    <option value="new-build">New Build</option>
                                    <option value="upgrade">Upgrade</option>
                                    <option value="breakfix">BreakFix</option>
                                    <option value="custom">Custom Project</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="projectStatus">Initial Status</label>
                                <select id="projectStatus" name="status">
                                    <option value="draft" selected> Draft</option>
                                    <option value="active"> Active</option>
                                    <option value="on-hold"> On Hold</option>
                                </select>
                                <small class="form-help">Default is Draft - will auto-update based on tasks</small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="projectPriority">Priority</label>
                                <select id="projectPriority" name="priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="requestDate">Request Date *</label>
                                <input type="date" id="requestDate" name="requestDate" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                            <div class="form-group">
                                <label for="projectStartDate">Start Date</label>
                                <input type="date" id="projectStartDate" name="startDate">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dueDate">Due Date *</label>
                                <input type="date" id="dueDate" name="dueDate" required>
                            </div>
                            <div class="form-group">
                                <label for="estimatedBudget">Estimated Budget *</label>
                                <input type="number" id="estimatedBudget" name="estimatedBudget" min="0" step="100" placeholder="0" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="projectStatus">Initial Status</label>
                                <select id="projectStatus" name="status">
                                    <option value="draft">Draft</option>
                                    <option value="active" selected>Active</option>
                                    <option value="on-hold">On Hold</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <!-- Empty space for alignment -->
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.project-modal-overlay').remove()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create Project</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function createProject(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const projectData = {
                name: formData.get('name'),
                requestorInfo: formData.get('requestorInfo'),
                siteLocation: formData.get('siteLocation'),
                businessLine: formData.get('businessLine'),
                description: formData.get('description'),
                type: formData.get('type'),
                priority: formData.get('priority'),
                requestDate: formData.get('requestDate'),
                startDate: formData.get('startDate'),
                dueDate: formData.get('dueDate'),
                endDate: formData.get('dueDate'), // Using dueDate as endDate for compatibility
                estimatedBudget: parseFloat(formData.get('estimatedBudget')) || 0,
                actualBudget: 0,
                status: formData.get('status'),
                progress: 0,
                tasks: []
            };

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = 'Creating...';
            submitBtn.disabled = true;

            try {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Add unique ID and timestamps
                projectData.id = 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                projectData.createdAt = new Date().toISOString();
                projectData.updatedAt = new Date().toISOString();
                
                // Add to AppState
                AppState.projects.unshift(projectData);
                
                // Save to localStorage
                localStorage.setItem('avProjectsData', JSON.stringify(AppState.projects));
                
                showNotification('Project created successfully!', 'success');
                
            } catch (error) {
                console.error('Error creating project:', error);
                showNotification('Failed to create project. Please try again.', 'error');
                submitBtn.innerHTML = 'Create Project';
                submitBtn.disabled = false;
                return;
            }

            // Close modal and refresh
            form.closest('.project-modal-overlay').remove();
            await renderProjectsGrid();
        }

        function viewProject(projectId) {
            console.log(' ViewProject called with ID:', projectId);
            
            const project = AppState.projects.find(p => p.id === projectId);
            
            if (!project) {
                showNotification('Project not found: ' + projectId, 'error');
                return;
            }
            
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'project-modal-overlay';
            
            modal.innerHTML = `
                <div class="project-modal">
                    <div class="modal-header">
                        <h3> ${project.name}</h3>
                        <button class="close-btn" onclick="this.closest('.project-modal-overlay').remove()"></button>
                    </div>
                    
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <div class="project-info">
                            <div class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                <div><strong>Status:</strong> <span class="status-badge ${project.status}">${formatStatus(project.status)}</span></div>
                                <div><strong>Progress:</strong> ${project.progress || 0}%</div>
                                <div><strong>Requestor:</strong> ${project.requestorInfo || 'N/A'}</div>
                                <div><strong>Business Line:</strong> ${formatBusinessLine(project.businessLine)}</div>
                                <div><strong>Location:</strong> ${project.siteLocation || 'N/A'}</div>
                                <div><strong>Type:</strong> ${formatProjectType(project.type)}</div>
                                <div><strong>Budget:</strong> $${(project.estimatedBudget || 0).toLocaleString()}</div>
                                <div><strong>Start Date:</strong> ${project.startDate ? formatDate(project.startDate) : 'N/A'}</div>
                            </div>
                            
                            ${project.description ? `<div><strong>Description:</strong> ${project.description}</div>` : ''}
                        </div>
                        
                        <div class="project-tasks">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin: 1.5rem 0 1rem 0;">
                                <h4> Tasks (${project.tasks ? project.tasks.length : 0})</h4>
                                <button class="btn btn-primary" onclick="addNewTask('${projectId}')">+ Add Task</button>
                            </div>
                            
                            <div id="projectTasks-${projectId}">
                                ${project.tasks && project.tasks.length > 0 ? 
                                    project.tasks.map(task => {
                                        const ragInfo = {
                                            'green': { icon: '', label: 'Green', class: 'rag-green' },
                                            'yellow': { icon: '', label: 'Yellow', class: 'rag-yellow' }, 
                                            'red': { icon: '', label: 'Red', class: 'rag-red' }
                                        };
                                        const rag = ragInfo[task.ragStatus] || ragInfo.yellow;
                                        
                                        return `
                                        <div class="task-item" style="border: 1px solid var(--gray-200); padding: 1rem; margin: 0.5rem 0; border-radius: 0.5rem; background: var(--gray-50);">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                        <h5 style="margin: 0;">${task.name}</h5>
                                                        <span class="${rag.class}" style="font-size: 0.8rem;">${rag.icon} ${rag.label}</span>
                                                        ${task.status === 'completed' ? '<span style="color: var(--success-500); font-size: 0.8rem;"> Completed</span>' : ''}
                                                    </div>
                                                    <p style="color: var(--gray-600); font-size: 0.875rem; margin: 0 0 0.5rem 0;">${task.description || 'No description'}</p>
                                                    <div style="display: flex; gap: 1rem; font-size: 0.8rem; color: var(--gray-500); margin-bottom: 0.5rem;">
                                                        <span><strong>Status:</strong> <span class="status-badge ${task.status}">${formatStatus(task.status)}</span></span>
                                                        ${task.assignee ? `<span><strong>Assigned:</strong> ${task.assignee}</span>` : ''}
                                                        ${task.priority ? `<span><strong>Priority:</strong> ${task.priority}</span>` : ''}
                                                        ${task.estimatedHours ? `<span><strong>Est Hours:</strong> ${task.estimatedHours}h</span>` : ''}
                                                    </div>
                                                    ${task.notes ? `
                                                        <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem;">
                                                            <strong style="font-size: 0.8rem; color: var(--gray-700);">PM Notes:</strong>
                                                            <p style="font-size: 0.8rem; color: var(--gray-600); margin: 0.25rem 0 0 0;">${task.notes}</p>
                                                        </div>
                                                    ` : ''}
                                                    ${task.completedDate ? `
                                                        <div style="font-size: 0.75rem; color: var(--success-600); margin-top: 0.5rem;">
                                                             Completed: ${formatDate(task.completedDate)}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                    ${task.status !== 'completed' ? 
                                                        `<button class="btn btn-success btn-sm" onclick="completeTask('${projectId}', '${task.id}')" title="Mark Complete"> Complete</button>` :
                                                        `<button class="btn btn-warning btn-sm" onclick="reopenTask('${projectId}', '${task.id}')" title="Reopen Task"> Reopen</button>`
                                                    }
                                                    <button class="btn btn-secondary btn-sm" onclick="editTask('${projectId}', '${task.id}')" title="Edit Task"> Edit</button>
                                                    <button class="btn btn-danger btn-sm" onclick="deleteTask('${projectId}', '${task.id}')" title="Delete Task"> Delete</button>
                                                </div>
                                            </div>
                                        </div>
                                        `;
                                    }).join('') 
                                    : '<div style="text-align: center; padding: 2rem; color: var(--gray-500);"><p>No tasks yet. Click "Add Task" to get started.</p></div>'
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        ${AppState.user && (AppState.user.role === 'Admin' || AppState.user.role === 'Project-Manager') ? 
                            `<button class="btn btn-secondary" onclick="editProject('${projectId}')">Edit Project</button>` : ''
                        }
                        <button class="btn btn-secondary" onclick="this.closest('.project-modal-overlay').remove()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log(' Project detail modal displayed for:', project.name);
        }
        
        function renderProjectTasks(tasks, projectId) {
            if (!tasks || tasks.length === 0) {
                return `
                    <div class="no-tasks">
                        <div class="no-tasks-icon"></div>
                        <p>No tasks created yet.</p>
                        <p class="text-muted">Click "Add Task" to get started.</p>
                    </div>
                `;
            }
            
            return tasks.map(task => `
                <div class="task-item" data-task-id="${task.id}">
                    <div class="task-header">
                        <div class="task-info">
                            <h5 class="task-name">${task.name}</h5>
                            <div class="task-meta">
                                <span class="task-status ${task.status}">${formatStatus(task.status)}</span>
                                ${task.priority ? `<span class="task-priority ${task.priority}">${formatStatus(task.priority)}</span>` : ''}
                                ${task.assignee ? `<span class="task-assignee"> ${task.assignee}</span>` : ''}
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="btn-icon" onclick="editTask('${projectId}', '${task.id}')" title="Edit Task"></button>
                            <button class="btn-icon" onclick="deleteTask('${projectId}', '${task.id}')" title="Delete Task"></button>
                        </div>
                    </div>
                    ${task.description ? `<p class="task-description">${task.description}</p>` : ''}
                    <div class="task-details">
                        ${task.startDate ? `<span class="task-detail"> ${formatDate(task.startDate)}</span>` : ''}
                        ${task.endDate ? `<span class="task-detail"> ${formatDate(task.endDate)}</span>` : ''}
                        ${task.estimatedHours ? `<span class="task-detail"> ${task.estimatedHours}h</span>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function addNewTask(projectId) {
            const modal = document.createElement('div');
            modal.className = 'project-modal-overlay task-modal-overlay';
            modal.innerHTML = `
                <div class="project-modal task-modal">
                    <div class="modal-header">
                        <h3>Add New Task</h3>
                        <button class="close-btn" onclick="this.closest('.task-modal-overlay').remove()"></button>
                    </div>
                    <form class="modal-body" onsubmit="createTask(event, '${projectId}')">
                        <div class="form-group">
                            <label for="taskName">Task Name *</label>
                            <input type="text" id="taskName" name="name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="taskDescription">Description</label>
                            <textarea id="taskDescription" name="description" rows="3"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskStatus">Status</label>
                                <select id="taskStatus" name="status">
                                    <option value="not-started">Not Started</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="on-hold">On Hold</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="taskRAGStatus">RAG Status</label>
                                <select id="taskRAGStatus" name="ragStatus">
                                    <option value="green"> Green - On Track</option>
                                    <option value="yellow" selected> Yellow - At Risk</option>
                                    <option value="red"> Red - Critical Issues</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskPriority">Priority</label>
                                <select id="taskPriority" name="priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="taskAssignee">Assignee</label>
                                <input type="text" id="taskAssignee" name="assignee" placeholder="Assigned to">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskEstimatedHours">Estimated Hours</label>
                                <input type="number" id="taskEstimatedHours" name="estimatedHours" min="0" step="0.5">
                            </div>
                            <div class="form-group">
                                <!-- Empty for layout -->
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskStartDate">Start Date</label>
                                <input type="date" id="taskStartDate" name="startDate">
                            </div>
                            <div class="form-group">
                                <label for="taskEndDate">End Date</label>
                                <input type="date" id="taskEndDate" name="endDate">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="taskNotes">PM Notes</label>
                            <textarea id="taskNotes" name="notes" rows="4" placeholder="Project manager notes and updates..."></textarea>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.task-modal-overlay').remove()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Task</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function createTask(event, projectId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const taskData = {
                id: 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: formData.get('name'),
                description: formData.get('description'),
                status: formData.get('status'),
                ragStatus: formData.get('ragStatus') || 'yellow',
                priority: formData.get('priority'),
                assignee: formData.get('assignee'),
                estimatedHours: parseFloat(formData.get('estimatedHours')) || null,
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                notes: formData.get('notes') || '',
                completedDate: formData.get('status') === 'completed' ? new Date().toISOString() : null,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = 'Adding...';
            submitBtn.disabled = true;

            try {
                // Find the project and add the task
                const projectIndex = AppState.projects.findIndex(p => p.id === projectId);
                if (projectIndex !== -1) {
                    if (!AppState.projects[projectIndex].tasks) {
                        AppState.projects[projectIndex].tasks = [];
                    }
                    AppState.projects[projectIndex].tasks.push(taskData);
                    
                    // Recalculate project progress and status
                    const project = AppState.projects[projectIndex];
                    project.progress = calculateProjectProgress(project);
                    project.status = calculateProjectStatus(project);
                    project.updatedAt = new Date().toISOString();
                    
                    // Save to localStorage
                    localStorage.setItem('avProjectsData', JSON.stringify(AppState.projects));
                    
                    showNotification('Task added successfully!', 'success');
                    form.closest('.task-modal-overlay').remove();
                    
                    // Refresh the task list in the project detail view
                    const tasksContainer = document.getElementById(`projectTasks-${projectId}`);
                    if (tasksContainer) {
                        tasksContainer.innerHTML = renderProjectTasks(AppState.projects[projectIndex].tasks, projectId);
                    }
                    
                    // Refresh other views if visible
                    if (AppState.currentView === 'projects') {
                        renderProjectsGrid();
                    } else if (AppState.currentView === 'dashboard') {
                        loadDashboard();
                    }
                } else {
                    throw new Error('Project not found');
                }
                
            } catch (error) {
                console.error('Error adding task:', error);
                showNotification('Failed to add task. Please try again.', 'error');
                submitBtn.innerHTML = 'Add Task';
                submitBtn.disabled = false;
            }
        }
        
        function editTask(projectId, taskId) {
            const project = AppState.projects.find(p => p.id === projectId);
            const task = project?.tasks?.find(t => t.id === taskId);
            
            if (!task) {
                showNotification('Task not found', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'project-modal-overlay task-modal-overlay';
            modal.innerHTML = `
                <div class="project-modal task-modal">
                    <div class="modal-header">
                        <h3>Edit Task</h3>
                        <button class="close-btn" onclick="this.closest('.task-modal-overlay').remove()"></button>
                    </div>
                    <form class="modal-body" onsubmit="updateTask(event, '${projectId}', '${taskId}')">
                        <div class="form-group">
                            <label for="editTaskName">Task Name *</label>
                            <input type="text" id="editTaskName" name="name" value="${task.name}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editTaskDescription">Description</label>
                            <textarea id="editTaskDescription" name="description" rows="3">${task.description || ''}</textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTaskStatus">Status</label>
                                <select id="editTaskStatus" name="status">
                                    <option value="not-started" ${task.status === 'not-started' ? 'selected' : ''}>Not Started</option>
                                    <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="on-hold" ${task.status === 'on-hold' ? 'selected' : ''}>On Hold</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editTaskRAGStatus">RAG Status</label>
                                <select id="editTaskRAGStatus" name="ragStatus">
                                    <option value="green" ${(task.ragStatus || 'yellow') === 'green' ? 'selected' : ''}> Green - On Track</option>
                                    <option value="yellow" ${(task.ragStatus || 'yellow') === 'yellow' ? 'selected' : ''}> Yellow - At Risk</option>
                                    <option value="red" ${(task.ragStatus || 'yellow') === 'red' ? 'selected' : ''}> Red - Critical Issues</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTaskPriority">Priority</label>
                                <select id="editTaskPriority" name="priority">
                                    <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Low</option>
                                    <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>Medium</option>
                                    <option value="high" ${task.priority === 'high' ? 'selected' : ''}>High</option>
                                    <option value="critical" ${task.priority === 'critical' ? 'selected' : ''}>Critical</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editTaskAssignee">Assignee</label>
                                <input type="text" id="editTaskAssignee" name="assignee" value="${task.assignee || ''}" placeholder="Assigned to">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTaskEstimatedHours">Estimated Hours</label>
                                <input type="number" id="editTaskEstimatedHours" name="estimatedHours" value="${task.estimatedHours || ''}" min="0" step="0.5">
                            </div>
                            <div class="form-group">
                                <!-- Empty for layout -->
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTaskStartDate">Start Date</label>
                                <input type="date" id="editTaskStartDate" name="startDate" value="${task.startDate || ''}">
                            </div>
                            <div class="form-group">
                                <label for="editTaskEndDate">End Date</label>
                                <input type="date" id="editTaskEndDate" name="endDate" value="${task.endDate || ''}">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editTaskNotes">PM Notes</label>
                            <textarea id="editTaskNotes" name="notes" rows="4" placeholder="Project manager notes and updates...">${task.notes || ''}</textarea>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.task-modal-overlay').remove()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Task</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function updateTask(event, projectId, taskId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const updatedTaskData = {
                name: formData.get('name'),
                description: formData.get('description'),
                status: formData.get('status'),
                ragStatus: formData.get('ragStatus') || 'yellow',
                priority: formData.get('priority'),
                assignee: formData.get('assignee'),
                estimatedHours: parseFloat(formData.get('estimatedHours')) || null,
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                notes: formData.get('notes') || '',
                updatedAt: new Date().toISOString()
            };
            
            // Handle completion date
            const currentTask = AppState.projects.find(p => p.id === projectId)?.tasks?.find(t => t.id === taskId);
            if (formData.get('status') === 'completed' && currentTask?.status !== 'completed') {
                updatedTaskData.completedDate = new Date().toISOString();
            } else if (formData.get('status') !== 'completed' && currentTask?.status === 'completed') {
                updatedTaskData.completedDate = null;
            }

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = 'Updating...';
            submitBtn.disabled = true;

            try {
                // Find the project and task
                const projectIndex = AppState.projects.findIndex(p => p.id === projectId);
                const taskIndex = AppState.projects[projectIndex]?.tasks?.findIndex(t => t.id === taskId);
                
                if (projectIndex !== -1 && taskIndex !== -1) {
                    // Update the task
                    AppState.projects[projectIndex].tasks[taskIndex] = {
                        ...AppState.projects[projectIndex].tasks[taskIndex],
                        ...updatedTaskData
                    };
                    
                    // Recalculate project progress and status
                    const project = AppState.projects[projectIndex];
                    project.progress = calculateProjectProgress(project);
                    project.status = calculateProjectStatus(project);
                    project.updatedAt = new Date().toISOString();
                    
                    // Save to localStorage
                    localStorage.setItem('avProjectsData', JSON.stringify(AppState.projects));
                    
                    showNotification('Task updated successfully!', 'success');
                    form.closest('.task-modal-overlay').remove();
                    
                    // Refresh the task list in the project detail view
                    const tasksContainer = document.getElementById(`projectTasks-${projectId}`);
                    if (tasksContainer) {
                        tasksContainer.innerHTML = renderProjectTasks(AppState.projects[projectIndex].tasks, projectId);
                    }
                    
                    // Refresh other views if visible
                    if (AppState.currentView === 'projects') {
                        renderProjectsGrid();
                    } else if (AppState.currentView === 'dashboard') {
                        loadDashboard();
                    }
                } else {
                    throw new Error('Project or task not found');
                }
                
            } catch (error) {
                console.error('Error updating task:', error);
                showNotification('Failed to update task. Please try again.', 'error');
                submitBtn.innerHTML = 'Update Task';
                submitBtn.disabled = false;
            }
        }
        
        function deleteTask(projectId, taskId) {
            const project = AppState.projects.find(p => p.id === projectId);
            const task = project?.tasks?.find(t => t.id === taskId);
            
            if (!task) {
                showNotification('Task not found', 'error');
                return;
            }
            
            // Show confirmation dialog
            const confirmDelete = confirm(`Are you sure you want to delete "${task.name}"? This action cannot be undone.`);
            
            if (confirmDelete) {
                // Remove task from project
                const projectIndex = AppState.projects.findIndex(p => p.id === projectId);
                if (projectIndex !== -1) {
                    AppState.projects[projectIndex].tasks = AppState.projects[projectIndex].tasks.filter(t => t.id !== taskId);
                    
                    // Recalculate project progress and status
                    const project = AppState.projects[projectIndex];
                    project.progress = calculateProjectProgress(project);
                    project.status = calculateProjectStatus(project);
                    project.updatedAt = new Date().toISOString();
                    
                    // Save to localStorage
                    localStorage.setItem('avProjectsData', JSON.stringify(AppState.projects));
                    
                    showNotification('Task deleted successfully!', 'success');
                    
                    // Refresh the task list in the project detail view
                    const tasksContainer = document.getElementById(`projectTasks-${projectId}`);
                    if (tasksContainer) {
                        tasksContainer.innerHTML = renderProjectTasks(AppState.projects[projectIndex].tasks, projectId);
                    }
                    
                    // Refresh other views if visible
                    if (AppState.currentView === 'projects') {
                        renderProjectsGrid();
                    } else if (AppState.currentView === 'dashboard') {
                        loadDashboard();
                    }
                }
            }
        }
        
        function calculateProjectProgress(project) {
            const tasks = project.tasks || [];
            if (tasks.length === 0) return 0;
            
            const completedTasks = tasks.filter(task => task.status === 'completed').length;
            const inProgressTasks = tasks.filter(task => task.status === 'in-progress').length;
            
            // Give partial credit for in-progress tasks
            const totalProgress = completedTasks + (inProgressTasks * 0.5);
            return Math.round((totalProgress / tasks.length) * 100);
        }

        function calculateProjectStatus(project) {
            const tasks = project.tasks || [];
            if (tasks.length === 0) {
                // No tasks - keep current status or default to draft
                return project.status || 'draft';
            }
            
            const completedTasks = tasks.filter(task => task.status === 'completed').length;
            const inProgressTasks = tasks.filter(task => task.status === 'in-progress').length;
            const onHoldTasks = tasks.filter(task => task.status === 'on-hold').length;
            const notStartedTasks = tasks.filter(task => task.status === 'not-started').length;
            
            // Business logic for automatic status updates:
            if (completedTasks === tasks.length) {
                // All tasks completed = project completed
                return 'completed';
            } else if (inProgressTasks > 0) {
                // Any task in progress = project is active
                return 'active';
            } else if (onHoldTasks === tasks.length) {
                // All tasks on hold = project on hold
                return 'on-hold';
            } else if (notStartedTasks === tasks.length) {
                // All tasks not started = keep current status (could be draft or active)
                return project.status === 'completed' ? 'active' : project.status || 'draft';
            } else {
                // Mixed states but no in-progress = active (project has been worked on)
                return 'active';
            }
        }
        
        function getProgressColor(progress) {
            if (progress >= 75) return '#10b981';
            if (progress >= 50) return '#3b82f6';
            if (progress >= 25) return '#f59e0b';
            return '#ef4444';
        }

        function showProjectMenu(projectId) {
            // Remove any existing menu
            const existingMenu = document.querySelector('.project-menu-dropdown');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            const menu = document.createElement('div');
            menu.className = 'project-menu-dropdown';
            menu.innerHTML = `
                <div class="menu-item" onclick="console.log('Edit clicked for ${projectId}'); editProject('${projectId}')">
                    <span class="menu-icon"></span>
                    <span>Edit Project</span>
                </div>
                <div class="menu-item" onclick="console.log('View clicked for ${projectId}'); viewProject('${projectId}')">
                    <span class="menu-icon"></span>
                    <span>View Details</span>
                </div>
                <div class="menu-item" onclick="duplicateProject('${projectId}')">
                    <span class="menu-icon"></span>
                    <span>Duplicate</span>
                </div>
                <div class="menu-separator"></div>
                <div class="menu-item danger" onclick="deleteProject('${projectId}')">
                    <span class="menu-icon"></span>
                    <span>Delete Project</span>
                </div>
            `;
            
            // Position the menu relative to the clicked button
            const button = event.target.closest('.menu-btn');
            const rect = button.getBoundingClientRect();
            menu.style.position = 'fixed';
            menu.style.top = (rect.bottom + 5) + 'px';
            menu.style.left = (rect.left - 120) + 'px';
            menu.style.zIndex = '2000';
            
            document.body.appendChild(menu);
            
            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 0);
        }

        function editProject(projectId) {
            console.log(' DEBUG: editProject called with ID:', projectId);
            console.log(' DEBUG: Available projects:', AppState.projects?.length || 0);
            
            const project = AppState.projects.find(p => p.id === projectId);
            console.log(' DEBUG: Found project for edit:', project?.name || 'not found');
            
            if (!project) {
                console.error(' DEBUG: Project not found, showing error notification');
                showNotification('Project not found', 'error');
                return;
            }
            
            // Close any existing menu
            const existingMenu = document.querySelector('.project-menu-dropdown');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            const modal = document.createElement('div');
            modal.className = 'project-modal-overlay';
            modal.innerHTML = `
                <div class="project-modal">
                    <div class="modal-header">
                        <h3>Edit Project</h3>
                        <button class="close-btn" onclick="this.closest('.project-modal-overlay').remove()"></button>
                    </div>
                    <form class="modal-body" onsubmit="updateProject(event, '${projectId}')">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editProjectName">Project Name *</label>
                                <input type="text" id="editProjectName" name="name" value="${project.name}" required>
                            </div>
                            <div class="form-group">
                                <label for="editRequestorInfo">Requestor Information *</label>
                                <input type="text" id="editRequestorInfo" name="requestorInfo" value="${project.requestorInfo || ''}" placeholder="Name, Company, Contact" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editSiteLocation">Site/Location *</label>
                                <input type="text" id="editSiteLocation" name="siteLocation" value="${project.siteLocation || ''}" placeholder="Address or Site Name" required>
                            </div>
                            <div class="form-group">
                                <label for="editBusinessLine">Business Line *</label>
                                <select id="editBusinessLine" name="businessLine" required>
                                    <option value="">Select Business Line</option>
                                    <option value="corporate" ${project.businessLine === 'corporate' ? 'selected' : ''}>Corporate</option>
                                    <option value="education" ${project.businessLine === 'education' ? 'selected' : ''}>Education</option>
                                    <option value="healthcare" ${project.businessLine === 'healthcare' ? 'selected' : ''}>Healthcare</option>
                                    <option value="retail" ${project.businessLine === 'retail' ? 'selected' : ''}>Retail</option>
                                    <option value="hospitality" ${project.businessLine === 'hospitality' ? 'selected' : ''}>Hospitality</option>
                                    <option value="government" ${project.businessLine === 'government' ? 'selected' : ''}>Government</option>
                                    <option value="residential" ${project.businessLine === 'residential' ? 'selected' : ''}>Residential</option>
                                    <option value="entertainment" ${project.businessLine === 'entertainment' ? 'selected' : ''}>Entertainment</option>
                                </select>
                            </div>
                        </div>
                        
                        
                        <div class="form-group">
                            <label for="editProjectDescription">Project Description</label>
                            <textarea id="editProjectDescription" name="description" rows="3" placeholder="Detailed project requirements and scope">${project.description || ''}</textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editProjectType">Project Type *</label>
                                <select id="editProjectType" name="type" required>
                                    <option value="">Select Project Type</option>
                                    <option value="new-build" ${project.type === 'new-build' ? 'selected' : ''}>New Build</option>
                                    <option value="upgrade" ${project.type === 'upgrade' ? 'selected' : ''}>Upgrade</option>
                                    <option value="breakfix" ${project.type === 'breakfix' ? 'selected' : ''}>BreakFix</option>
                                    <option value="custom" ${project.type === 'custom' ? 'selected' : ''}>Custom Project</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editProjectStatus">Project Status</label>
                                <select id="editProjectStatus" name="status">
                                    <option value="draft" ${project.status === 'draft' ? 'selected' : ''}> Draft</option>
                                    <option value="active" ${project.status === 'active' ? 'selected' : ''}> Active</option>
                                    <option value="on-hold" ${project.status === 'on-hold' ? 'selected' : ''}> On Hold</option>
                                    <option value="completed" ${project.status === 'completed' ? 'selected' : ''}> Completed</option>
                                    <option value="cancelled" ${project.status === 'cancelled' ? 'selected' : ''}> Cancelled</option>
                                </select>
                                <small class="form-help">Manual override - automatically updates based on task status</small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editProjectPriority">Priority</label>
                                <select id="editProjectPriority" name="priority">
                                    <option value="low" ${project.priority === 'low' ? 'selected' : ''}>Low</option>
                                    <option value="medium" ${project.priority === 'medium' ? 'selected' : ''}>Medium</option>
                                    <option value="high" ${project.priority === 'high' ? 'selected' : ''}>High</option>
                                    <option value="critical" ${project.priority === 'critical' ? 'selected' : ''}>Critical</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <!-- Empty for layout balance -->
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editRequestDate">Request Date *</label>
                                <input type="date" id="editRequestDate" name="requestDate" value="${project.requestDate || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="editProjectStartDate">Start Date</label>
                                <input type="date" id="editProjectStartDate" name="startDate" value="${project.startDate || ''}">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editDueDate">Due Date *</label>
                                <input type="date" id="editDueDate" name="dueDate" value="${project.endDate || project.dueDate || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="editEstimatedBudget">Estimated Budget *</label>
                                <input type="number" id="editEstimatedBudget" name="estimatedBudget" min="0" step="100" value="${project.estimatedBudget || 0}" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editProjectStatus">Status</label>
                                <select id="editProjectStatus" name="status">
                                    <option value="draft" ${project.status === 'draft' ? 'selected' : ''}>Draft</option>
                                    <option value="active" ${project.status === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="on-hold" ${project.status === 'on-hold' ? 'selected' : ''}>On Hold</option>
                                    <option value="completed" ${project.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="cancelled" ${project.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editActualBudget">Actual Budget</label>
                                <input type="number" id="editActualBudget" name="actualBudget" min="0" step="100" value="${project.actualBudget || 0}">
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.project-modal-overlay').remove()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Project</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function updateProject(event, projectId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const updatedData = {
                name: formData.get('name'),
                requestorInfo: formData.get('requestorInfo'),
                siteLocation: formData.get('siteLocation'),
                businessLine: formData.get('businessLine'),
                description: formData.get('description'),
                type: formData.get('type'),
                priority: formData.get('priority'),
                requestDate: formData.get('requestDate'),
                startDate: formData.get('startDate'),
                dueDate: formData.get('dueDate'),
                endDate: formData.get('dueDate'), // Using dueDate as endDate for compatibility
                estimatedBudget: parseFloat(formData.get('estimatedBudget')) || 0,
                actualBudget: parseFloat(formData.get('actualBudget')) || 0,
                status: formData.get('status')
            };

            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = 'Updating...';
            submitBtn.disabled = true;

            try {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Find and update the project in AppState
                const projectIndex = AppState.projects.findIndex(p => p.id === projectId);
                if (projectIndex !== -1) {
                    const project = AppState.projects[projectIndex];
                    
                    // Validate status change - warn if setting to completed with incomplete tasks
                    if (updatedData.status === 'completed' && project.tasks && project.tasks.length > 0) {
                        const incompleteTasks = project.tasks.filter(t => t.status !== 'completed');
                        if (incompleteTasks.length > 0) {
                            if (!confirm(`Warning: This project has ${incompleteTasks.length} incomplete task(s). Setting the project status to "Completed" while tasks remain incomplete may affect reporting accuracy.\n\nDo you want to proceed?`)) {
                                submitBtn.innerHTML = 'Update Project';
                                submitBtn.disabled = false;
                                return;
                            }
                        }
                    }
                    
                    AppState.projects[projectIndex] = { 
                        ...AppState.projects[projectIndex], 
                        ...updatedData,
                        updatedAt: new Date().toISOString()
                    };
                    
                    // Save to localStorage
                    localStorage.setItem('avProjectsData', JSON.stringify(AppState.projects));
                    
                    showNotification('Project updated successfully!', 'success');
                    form.closest('.project-modal-overlay').remove();
                    
                    // Refresh the current view
                    if (AppState.currentView === 'projects') {
                        renderProjectsGrid();
                    } else if (AppState.currentView === 'dashboard') {
                        loadDashboard();
                    }
                } else {
                    throw new Error('Project not found');
                }
                
            } catch (error) {
                console.error('Error updating project:', error);
                showNotification('Failed to update project. Please try again.', 'error');
                submitBtn.innerHTML = 'Update Project';
                submitBtn.disabled = false;
            }
        }

        function duplicateProject(projectId) {
            const project = AppState.projects.find(p => p.id === projectId);
            if (!project) {
                showNotification('Project not found', 'error');
                return;
            }
            
            // Close any existing menu
            const existingMenu = document.querySelector('.project-menu-dropdown');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // Create a duplicate project
            const duplicatedProject = {
                ...project,
                id: 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: project.name + ' (Copy)',
                progress: 0,
                status: 'draft',
                tasks: project.tasks ? project.tasks.map(task => ({
                    ...task,
                    id: 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    status: 'not-started'
                })) : [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Add to projects array
            AppState.projects.unshift(duplicatedProject);
            
            // Save to localStorage
            localStorage.setItem('avProjectsData', JSON.stringify(AppState.projects));
            
            showNotification('Project duplicated successfully!', 'success');
            
            // Refresh the current view
            if (AppState.currentView === 'projects') {
                renderProjectsGrid();
            } else if (AppState.currentView === 'dashboard') {
                loadDashboard();
            }
        }

        function completeTask(projectId, taskId) {
            const projectIndex = AppState.projects.findIndex(p => p.id === projectId);
            if (projectIndex !== -1) {
                const taskIndex = AppState.projects[projectIndex].tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    // Update task to completed status
                    AppState.projects[projectIndex].tasks[taskIndex].status = 'completed';
                    AppState.projects[projectIndex].tasks[taskIndex].completedDate = new Date().toISOString();
                    AppState.projects[projectIndex].tasks[taskIndex].updatedAt = new Date().toISOString();
                    
                    // Recalculate project progress and status
                    const project = AppState.projects[projectIndex];
                    project.progress = calculateProjectProgress(project);
                    project.status = calculateProjectStatus(project);
                    project.updatedAt = new Date().toISOString();
                    
                    // Save to localStorage
                    localStorage.setItem('avProjectsData', JSON.stringify(AppState.projects));
                    
                    showNotification('Task marked as complete!', 'success');
                    
                    // Refresh the task display
                    refreshTaskList(projectId);
                    
                    // Refresh other views if visible
                    if (AppState.currentView === 'projects') {
                        renderProjectsGrid();
                    } else if (AppState.currentView === 'dashboard') {
                        loadDashboard();
                    }
                }
            }
        }

        function reopenTask(projectId, taskId) {
            const projectIndex = AppState.projects.findIndex(p => p.id === projectId);
            if (projectIndex !== -1) {
                const taskIndex = AppState.projects[projectIndex].tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    // Update task to in-progress status
                    AppState.projects[projectIndex].tasks[taskIndex].status = 'in-progress';
                    AppState.projects[projectIndex].tasks[taskIndex].completedDate = null;
                    AppState.projects[projectIndex].tasks[taskIndex].updatedAt = new Date().toISOString();
                    
                    // Recalculate project progress and status
                    const project = AppState.projects[projectIndex];
                    project.progress = calculateProjectProgress(project);
                    project.status = calculateProjectStatus(project);
                    project.updatedAt = new Date().toISOString();
                    
                    // Save to localStorage
                    localStorage.setItem('avProjectsData', JSON.stringify(AppState.projects));
                    
                    showNotification('Task reopened and set to in-progress!', 'success');
                    
                    // Refresh the task display
                    refreshTaskList(projectId);
                }
            }
        }

        function refreshTaskList(projectId) {
            const project = AppState.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const tasksContainer = document.getElementById(`projectTasks-${projectId}`);
            if (tasksContainer) {
                const taskHtml = project.tasks.map(task => {
                    const ragInfo = {
                        'green': { icon: '', label: 'Green', class: 'rag-green' },
                        'yellow': { icon: '', label: 'Yellow', class: 'rag-yellow' }, 
                        'red': { icon: '', label: 'Red', class: 'rag-red' }
                    };
                    const rag = ragInfo[task.ragStatus] || ragInfo.yellow;
                    
                    return `
                    <div class="task-item" style="border: 1px solid var(--gray-200); padding: 1rem; margin: 0.5rem 0; border-radius: 0.5rem; background: var(--gray-50);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <h5 style="margin: 0;">${task.name}</h5>
                                    <span class="${rag.class}" style="font-size: 0.8rem;">${rag.icon} ${rag.label}</span>
                                    ${task.status === 'completed' ? '<span style="color: var(--success-500); font-size: 0.8rem;"> Completed</span>' : ''}
                                </div>
                                <p style="color: var(--gray-600); font-size: 0.875rem; margin: 0 0 0.5rem 0;">${task.description || 'No description'}</p>
                                <div style="display: flex; gap: 1rem; font-size: 0.8rem; color: var(--gray-500); margin-bottom: 0.5rem;">
                                    <span><strong>Status:</strong> <span class="status-badge ${task.status}">${formatStatus(task.status)}</span></span>
                                    ${task.assignee ? `<span><strong>Assigned:</strong> ${task.assignee}</span>` : ''}
                                    ${task.priority ? `<span><strong>Priority:</strong> ${task.priority}</span>` : ''}
                                    ${task.estimatedHours ? `<span><strong>Est Hours:</strong> ${task.estimatedHours}h</span>` : ''}
                                </div>
                                ${task.notes ? `
                                    <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem;">
                                        <strong style="font-size: 0.8rem; color: var(--gray-700);">PM Notes:</strong>
                                        <p style="font-size: 0.8rem; color: var(--gray-600); margin: 0.25rem 0 0 0;">${task.notes}</p>
                                    </div>
                                ` : ''}
                                ${task.completedDate ? `
                                    <div style="font-size: 0.75rem; color: var(--success-600); margin-top: 0.5rem;">
                                         Completed: ${formatDate(task.completedDate)}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                ${task.status !== 'completed' ? 
                                    `<button class="btn btn-success btn-sm" onclick="completeTask('${projectId}', '${task.id}')" title="Mark Complete"> Complete</button>` :
                                    `<button class="btn btn-warning btn-sm" onclick="reopenTask('${projectId}', '${task.id}')" title="Reopen Task"> Reopen</button>`
                                }
                                <button class="btn btn-secondary btn-sm" onclick="editTask('${projectId}', '${task.id}')" title="Edit Task"> Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteTask('${projectId}', '${task.id}')" title="Delete Task"> Delete</button>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
                
                tasksContainer.innerHTML = taskHtml || '<div style="text-align: center; padding: 2rem; color: var(--gray-500);"><p>No tasks yet. Click "Add Task" to get started.</p></div>';
            }
        }

        function deleteProject(projectId) {
            const project = AppState.projects.find(p => p.id === projectId);
            if (!project) {
                showNotification('Project not found', 'error');
                return;
            }
            
            // Close any existing menu
            const existingMenu = document.querySelector('.project-menu-dropdown');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // Show confirmation dialog
            const confirmDelete = confirm(`Are you sure you want to delete "${project.name}"? This action cannot be undone.`);
            
            if (confirmDelete) {
                // Remove project from AppState
                AppState.projects = AppState.projects.filter(p => p.id !== projectId);
                
                // Save to localStorage
                localStorage.setItem('avProjectsData', JSON.stringify(AppState.projects));
                
                showNotification('Project deleted successfully!', 'success');
                
                // Refresh the current view
                if (AppState.currentView === 'projects') {
                    renderProjectsGrid();
                } else if (AppState.currentView === 'dashboard') {
                    loadDashboard();
                }
            }
        }

        function exportDashboard() {
            exportReport();
        }

        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            if (userMenu) {
                userMenu.style.display = userMenu.style.display === 'none' ? 'block' : 'none';
            }
        }

        function showDashboardTab(tab) {
            console.log('Show dashboard tab:', tab);
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
            
            // Show different content based on tab
            switch(tab) {
                case 'overview':
                    showKeyMetricsView();
                    break;
                case 'trends':
                    showTrendsView();
                    break;
                case 'alerts':
                    showAlertsView();
                    break;
            }
        }

        function showKeyMetricsView() {
            const projects = AppState.projects || [];
            
            // Calculate key metrics from actual project data
            const totalProjects = projects.length;
            const activeProjects = projects.filter(p => p.status === 'active').length;
            const completedProjects = projects.filter(p => p.status === 'completed').length;
            const overdueProjects = projects.filter(p => {
                const dueDate = p.endDate || p.dueDate;
                return dueDate && new Date(dueDate) < new Date() && p.status !== 'completed';
            }).length;
            
            const avgProgress = projects.length > 0 
                ? Math.round(projects.reduce((sum, p) => sum + (p.progress || 0), 0) / projects.length)
                : 0;
            
            const totalBudget = projects.reduce((sum, p) => sum + (p.estimatedBudget || 0), 0);
            const spentBudget = projects.reduce((sum, p) => sum + (p.actualBudget || 0), 0);
            const budgetUtilization = totalBudget > 0 ? Math.round((spentBudget / totalBudget) * 100) : 0;
            
            const onTimeProjects = projects.filter(p => {
                if (p.status !== 'completed') return false;
                const dueDate = p.endDate || p.dueDate;
                const completedDate = p.completedDate;
                return dueDate && completedDate && new Date(completedDate) <= new Date(dueDate);
            }).length;
            
            const onTimeRate = completedProjects > 0 ? Math.round((onTimeProjects / completedProjects) * 100) : 0;
            
            const metrics = [
                {
                    icon: '',
                    iconClass: 'primary',
                    value: totalProjects.toString(),
                    label: 'Total Projects',
                    change: `${activeProjects} active`,
                    changeClass: activeProjects > 0 ? 'positive' : 'neutral'
                },
                {
                    icon: '',
                    iconClass: avgProgress > 75 ? 'success' : avgProgress > 50 ? 'warning' : 'danger',
                    value: `${avgProgress}%`,
                    label: 'Average Progress',
                    change: avgProgress > 75 ? 'On track' : avgProgress > 50 ? 'Moderate pace' : 'Needs attention',
                    changeClass: avgProgress > 75 ? 'positive' : avgProgress > 50 ? 'neutral' : 'negative'
                },
                {
                    icon: '',
                    iconClass: overdueProjects === 0 ? 'success' : overdueProjects <= 2 ? 'warning' : 'danger',
                    value: overdueProjects.toString(),
                    label: 'Overdue Projects',
                    change: overdueProjects === 0 ? 'All on schedule' : `${Math.round((overdueProjects/totalProjects)*100)}% of total`,
                    changeClass: overdueProjects === 0 ? 'positive' : 'negative'
                },
                {
                    icon: '',
                    iconClass: budgetUtilization <= 90 ? 'success' : budgetUtilization <= 100 ? 'warning' : 'danger',
                    value: `${budgetUtilization}%`,
                    label: 'Budget Utilization',
                    change: `$${spentBudget.toLocaleString()} of $${totalBudget.toLocaleString()}`,
                    changeClass: budgetUtilization <= 90 ? 'positive' : budgetUtilization <= 100 ? 'neutral' : 'negative'
                },
                {
                    icon: '',
                    iconClass: onTimeRate >= 80 ? 'success' : onTimeRate >= 60 ? 'warning' : 'danger',
                    value: `${onTimeRate}%`,
                    label: 'On-Time Delivery',
                    change: `${onTimeProjects} of ${completedProjects} completed`,
                    changeClass: onTimeRate >= 80 ? 'positive' : onTimeRate >= 60 ? 'neutral' : 'negative'
                },
                {
                    icon: '',
                    iconClass: 'primary',
                    value: `${Math.min(100, Math.round((activeProjects / Math.max(1, totalProjects)) * 100))}%`,
                    label: 'Team Utilization',
                    change: activeProjects > 0 ? 'Active workload' : 'Available capacity',
                    changeClass: activeProjects > 0 ? 'positive' : 'neutral'
                }
            ];
            
            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = metrics.map(metric => `
                <div class="metric-card fade-in">
                    <div class="metric-header">
                        <div class="metric-icon ${metric.iconClass}">${metric.icon}</div>
                    </div>
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-change ${metric.changeClass}">${metric.change}</div>
                </div>
            `).join('');
            
            // Show the charts grid
            const chartGrid = document.querySelector('.chart-grid');
            if (chartGrid) chartGrid.style.display = 'grid';
        }

        function showTrendsView() {
            const projects = AppState.projects || [];
            
            // Hide charts grid and show trends-specific content
            const chartGrid = document.querySelector('.chart-grid');
            if (chartGrid) chartGrid.style.display = 'none';
            
            // Calculate trend metrics
            const currentDate = new Date();
            const thirtyDaysAgo = new Date(currentDate.getTime() - (30 * 24 * 60 * 60 * 1000));
            const ninetyDaysAgo = new Date(currentDate.getTime() - (90 * 24 * 60 * 60 * 1000));
            
            // Recent project activity
            const recentProjects = projects.filter(p => {
                const created = new Date(p.createdAt || p.requestDate);
                return created >= thirtyDaysAgo;
            }).length;
            
            const recentCompletions = projects.filter(p => {
                const completed = new Date(p.completedDate || '1900-01-01');
                return completed >= thirtyDaysAgo && p.status === 'completed';
            }).length;
            
            // Budget trends
            const recentBudgetCommitments = projects.filter(p => {
                const created = new Date(p.createdAt || p.requestDate);
                return created >= thirtyDaysAgo;
            }).reduce((sum, p) => sum + (p.estimatedBudget || 0), 0);
            
            // Performance trends - calculate average project duration
            const completedProjectsWithDates = projects.filter(p => {
                // Only include completed projects with valid start and end dates
                return p.status === 'completed' && 
                       (p.startDate || p.createdAt) && 
                       p.completedDate &&
                       !isNaN(new Date(p.startDate || p.createdAt)) &&
                       !isNaN(new Date(p.completedDate));
            });

            const avgProjectDuration = completedProjectsWithDates.map(p => {
                const start = new Date(p.startDate || p.createdAt);
                const end = new Date(p.completedDate);
                const durationInDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                
                // Return valid duration or 0 if calculation results in invalid number
                return isNaN(durationInDays) || durationInDays < 0 ? 0 : durationInDays;
            }).filter(duration => duration > 0); // Remove zero durations
            
            const avgDuration = avgProjectDuration.length > 0 
                ? Math.round(avgProjectDuration.reduce((a, b) => a + b, 0) / avgProjectDuration.length)
                : 0;
            
            const trends = [
                {
                    icon: '',
                    iconClass: recentProjects > 0 ? 'success' : 'neutral',
                    value: recentProjects.toString(),
                    label: 'New Projects (30d)',
                    change: recentProjects > 0 ? 'Growing pipeline' : 'Stable pipeline',
                    changeClass: recentProjects > 0 ? 'positive' : 'neutral'
                },
                {
                    icon: '',
                    iconClass: recentCompletions > 0 ? 'success' : 'warning',
                    value: recentCompletions.toString(),
                    label: 'Completed (30d)',
                    change: recentCompletions > 0 ? 'Strong delivery' : 'Focus needed',
                    changeClass: recentCompletions > 0 ? 'positive' : 'negative'
                },
                {
                    icon: '',
                    iconClass: recentBudgetCommitments > 0 ? 'primary' : 'neutral',
                    value: `$${(recentBudgetCommitments / 1000).toFixed(0)}K`,
                    label: 'Budget Committed (30d)',
                    change: `${recentProjects} new commitments`,
                    changeClass: 'neutral'
                },
                {
                    icon: '',
                    iconClass: avgDuration <= 60 ? 'success' : avgDuration <= 120 ? 'warning' : 'danger',
                    value: `${avgDuration}d`,
                    label: 'Avg Project Duration',
                    change: avgDuration <= 60 ? 'Efficient delivery' : avgDuration <= 120 ? 'Moderate pace' : 'Long cycles',
                    changeClass: avgDuration <= 60 ? 'positive' : avgDuration <= 120 ? 'neutral' : 'negative'
                },
                {
                    icon: '',
                    iconClass: 'primary',
                    value: `${Math.round((recentCompletions / Math.max(1, recentProjects)) * 100)}%`,
                    label: 'Completion Rate',
                    change: 'Recent performance',
                    changeClass: 'neutral'
                },
                {
                    icon: '',
                    iconClass: 'warning',
                    value: projects.filter(p => p.status === 'active').length.toString(),
                    label: 'Projected Completions',
                    change: 'Next 30 days',
                    changeClass: 'neutral'
                }
            ];
            
            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = `
                <div class="trends-header" style="grid-column: 1 / -1; margin-bottom: 1rem;">
                    <h2 style="color: var(--gray-800); margin: 0;"> Trends Analysis</h2>
                    <p style="color: var(--gray-600); margin: 0.5rem 0 0 0;">Key performance indicators and project momentum over time</p>
                </div>
                ${trends.map(metric => `
                    <div class="metric-card fade-in">
                        <div class="metric-header">
                            <div class="metric-icon ${metric.iconClass}">${metric.icon}</div>
                        </div>
                        <div class="metric-value">${metric.value}</div>
                        <div class="metric-label">${metric.label}</div>
                        <div class="metric-change ${metric.changeClass}">${metric.change}</div>
                    </div>
                `).join('')}
            `;
        }

        function showAlertsView() {
            const projects = AppState.projects || [];
            const alerts = [];
            const currentDate = new Date();
            
            // Hide charts grid
            const chartGrid = document.querySelector('.chart-grid');
            if (chartGrid) chartGrid.style.display = 'none';
            
            // Generate alerts based on project conditions
            projects.forEach(project => {
                const dueDate = project.endDate || project.dueDate;
                const dueDateObj = dueDate ? new Date(dueDate) : null;
                const daysUntilDue = dueDateObj ? Math.ceil((dueDateObj - currentDate) / (1000 * 60 * 60 * 24)) : null;
                
                // CRITICAL ALERTS
                if (project.status !== 'completed' && dueDateObj && currentDate > dueDateObj) {
                    alerts.push({
                        level: 'critical',
                        icon: '',
                        title: 'Project Overdue',
                        message: `${project.name} is ${Math.abs(daysUntilDue)} days overdue`,
                        action: `View Project`,
                        projectId: project.id,
                        priority: 1
                    });
                }
                
                if (project.actualBudget && project.estimatedBudget && 
                    (project.actualBudget / project.estimatedBudget) > 1.1) {
                    const overage = Math.round(((project.actualBudget / project.estimatedBudget) - 1) * 100);
                    alerts.push({
                        level: 'critical',
                        icon: '',
                        title: 'Budget Overrun',
                        message: `${project.name} is ${overage}% over budget`,
                        action: 'Review Budget',
                        projectId: project.id,
                        priority: 1
                    });
                }
                
                // WARNING ALERTS  
                if (project.status === 'active' && dueDateObj && daysUntilDue <= 7 && daysUntilDue > 0) {
                    alerts.push({
                        level: 'warning',
                        icon: '',
                        title: 'Due Soon',
                        message: `${project.name} due in ${daysUntilDue} day${daysUntilDue === 1 ? '' : 's'}`,
                        action: 'Check Progress',
                        projectId: project.id,
                        priority: 2
                    });
                }
                
                if (project.status === 'active' && (project.progress || 0) < 25 && 
                    dueDateObj && daysUntilDue <= 30) {
                    alerts.push({
                        level: 'warning',
                        icon: '',
                        title: 'Slow Progress',
                        message: `${project.name} only ${project.progress || 0}% complete with ${daysUntilDue} days left`,
                        action: 'Review Tasks',
                        projectId: project.id,
                        priority: 2
                    });
                }
                
                const incompleteTasks = project.tasks ? project.tasks.filter(t => t.status !== 'completed').length : 0;
                if (project.status === 'completed' && incompleteTasks > 0) {
                    alerts.push({
                        level: 'warning',
                        icon: '',
                        title: 'Inconsistent Status',
                        message: `${project.name} marked complete but has ${incompleteTasks} open task${incompleteTasks === 1 ? '' : 's'}`,
                        action: 'Review Tasks',
                        projectId: project.id,
                        priority: 2
                    });
                }
                
                // INFO ALERTS
                if (project.status === 'on-hold') {
                    const onHoldDays = project.updatedAt ? 
                        Math.ceil((currentDate - new Date(project.updatedAt)) / (1000 * 60 * 60 * 24)) : 0;
                    if (onHoldDays >= 14) {
                        alerts.push({
                            level: 'info',
                            icon: '',
                            title: 'Long-term Hold',
                            message: `${project.name} on hold for ${onHoldDays} days`,
                            action: 'Review Status',
                            projectId: project.id,
                            priority: 3
                        });
                    }
                }
                
                if (project.status === 'active' && (!project.tasks || project.tasks.length === 0)) {
                    alerts.push({
                        level: 'info',
                        icon: '',
                        title: 'No Tasks Defined',
                        message: `${project.name} has no tasks - consider breaking down work`,
                        action: 'Add Tasks',
                        projectId: project.id,
                        priority: 3
                    });
                }
            });
            
            // Sort alerts by priority and limit
            alerts.sort((a, b) => a.priority - b.priority);
            const topAlerts = alerts.slice(0, 12);
            
            // Update badge count
            const alertBadge = document.querySelector('.nav-item[onclick*="alerts"] .nav-item-badge');
            if (alertBadge) {
                const criticalCount = alerts.filter(a => a.level === 'critical').length;
                alertBadge.textContent = criticalCount || alerts.length;
                alertBadge.style.display = alerts.length > 0 ? 'inline' : 'none';
            }
            
            const metricsGrid = document.getElementById('metricsGrid');
            if (topAlerts.length === 0) {
                metricsGrid.innerHTML = `
                    <div class="alert-empty" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                        <h2 style="color: var(--success-600); margin: 0 0 0.5rem 0;">All Clear!</h2>
                        <p style="color: var(--gray-600); margin: 0;">No critical issues or warnings detected across your projects.</p>
                    </div>
                `;
            } else {
                metricsGrid.innerHTML = `
                    <div class="alerts-header" style="grid-column: 1 / -1; margin-bottom: 1rem;">
                        <h2 style="color: var(--gray-800); margin: 0;"> Project Alerts</h2>
                        <p style="color: var(--gray-600); margin: 0.5rem 0 0 0;">Issues requiring immediate attention (${topAlerts.length} alert${topAlerts.length === 1 ? '' : 's'})</p>
                    </div>
                    ${topAlerts.map(alert => `
                        <div class="alert-card metric-card fade-in ${alert.level}" onclick="viewProject('${alert.projectId}')" style="cursor: pointer;">
                            <div class="metric-header">
                                <div class="metric-icon ${alert.level === 'critical' ? 'danger' : alert.level === 'warning' ? 'warning' : 'info'}">${alert.icon}</div>
                            </div>
                            <div class="alert-title" style="font-weight: 600; color: var(--gray-900); margin-bottom: 0.25rem;">${alert.title}</div>
                            <div class="alert-message" style="font-size: 0.875rem; color: var(--gray-700); margin-bottom: 0.5rem;">${alert.message}</div>
                            <div class="alert-action" style="font-size: 0.75rem; color: var(--primary-600); font-weight: 500;">${alert.action} </div>
                        </div>
                    `).join('')}
                `;
            }
        }

        let currentProjectView = 'list';
        let currentProjectFilter = 'all';

        function showProjectsTab(tab) {
            console.log('Show projects tab:', tab);
            currentProjectView = tab;
            
            // Update active state in sidebar
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.textContent.includes('List View') || 
                    item.textContent.includes('Kanban Board') || 
                    item.textContent.includes('Calendar View')) {
                    item.classList.remove('active');
                }
            });
            
            // Find and activate the clicked tab
            const tabs = document.querySelectorAll('.nav-item');
            tabs.forEach(tabElement => {
                const text = tabElement.textContent.toLowerCase();
                if ((tab === 'list' && text.includes('list view')) ||
                    (tab === 'kanban' && text.includes('kanban board')) ||
                    (tab === 'calendar' && text.includes('calendar view'))) {
                    tabElement.classList.add('active');
                }
            });
            
            // Render the appropriate view
            renderProjectView(tab, currentProjectFilter);
        }

        function renderProjectView(view, filter = 'all') {
            let projects = [...(AppState.projects || [])];
            
            // Apply filter first
            switch(filter) {
                case 'active':
                    projects = projects.filter(p => p.status === 'active');
                    break;
                case 'completed':
                    projects = projects.filter(p => p.status === 'completed');
                    break;
                case 'overdue':
                    projects = projects.filter(p => {
                        const dueDate = p.dueDate || p.endDate;
                        return dueDate && new Date(dueDate) < new Date() && p.status !== 'completed';
                    });
                    break;
            }
            
            // Render based on view type
            switch(view) {
                case 'list':
                    renderListView(projects);
                    break;
                case 'kanban':
                    renderKanbanView(projects);
                    break;
                case 'calendar':
                    renderCalendarView(projects);
                    break;
                default:
                    renderListView(projects);
            }
            
            // Update counts in sidebar
            updateProjectCounts();
        }

        // Current report state
        let currentReportPeriod = 'month';
        let currentReportTab = 'executive';

        function setReportPeriod(period) {
            console.log('Setting report period to:', period);
            currentReportPeriod = period;
            
            // Update active state in sidebar
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Reload current report with new period
            showReportTab(currentReportTab);
            showNotification(`Report period updated to: ${period}`, 'success');
        }

        function showReportTab(tab) {
            console.log('Show report tab:', tab);
            currentReportTab = tab;
            
            // Update active state in sidebar
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the clicked tab
            const tabs = document.querySelectorAll('.nav-item');
            tabs.forEach(tabElement => {
                if (tabElement.textContent.toLowerCase().includes(tab.toLowerCase())) {
                    tabElement.classList.add('active');
                }
            });
            
            // Load content based on tab
            switch(tab) {
                case 'executive':
                    showReportType('executive');
                    break;
                case 'detailed':
                    showReportType('analytics');
                    break;
                case 'financial':
                    loadFinancialReport();
                    break;
                case 'team':
                    loadTeamPerformanceReport();
                    break;
                default:
                    showReportType('analytics');
            }
        }

        function showReportType(type) {
            // Toggle between analytics and executive views
            const analyticsView = document.getElementById('analyticsView');
            const executiveView = document.getElementById('executiveView');
            const tabs = document.querySelectorAll('.tab-btn');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            
            if (type === 'executive') {
                analyticsView.style.display = 'none';
                executiveView.style.display = 'block';
                document.getElementById('executiveTab').classList.add('active');
                // Load executive summary data
                loadExecutiveSummary();
            } else {
                analyticsView.style.display = 'block';
                executiveView.style.display = 'none';
                // Find and activate analytics tab
                const analyticsTab = document.querySelector('.tab-btn:not(#executiveTab)');
                if (analyticsTab) analyticsTab.classList.add('active');
                // Reload analytics charts
                setTimeout(() => {
                    renderReportCharts();
                    loadProjectSummaryTable();
                }, 100);
            }
        }

        async function loadExecutiveSummary() {
            try {
                console.log('Loading executive summary...');
                const projects = AppState.projects || [];
                
                // Calculate metrics from actual project data
                const totalProjects = projects.length;
                const completedProjects = projects.filter(p => p.status === 'completed').length;
                const completionRate = totalProjects > 0 ? Math.round((completedProjects / totalProjects) * 100) : 0;
                
                // Calculate projects on budget (within 10% variance)
                const projectsWithBudgets = projects.filter(p => p.estimatedBudget && p.actualBudget);
                const projectsOnBudget = projectsWithBudgets.filter(p => {
                    const variance = Math.abs((p.actualBudget - p.estimatedBudget) / p.estimatedBudget) * 100;
                    return variance <= 10;
                }).length;
                
                const totalBudget = projects.reduce((sum, p) => sum + (p.estimatedBudget || 0), 0);
                const spentBudget = projects.reduce((sum, p) => sum + (p.actualBudget || 0), 0);
                const remainingBudget = totalBudget - spentBudget;
                
                const atRiskProjects = projects.filter(p => {
                    if (p.status === 'completed') return false;
                    if (p.endDate && new Date(p.endDate) < new Date()) return true;
                    if (p.progress < 50 && p.status === 'active') return true;
                    return false;
                }).length;
                
                // Update KPIs
                document.getElementById('kpi-projects').textContent = totalProjects;
                document.getElementById('kpi-completion').textContent = completionRate + '%';
                document.getElementById('kpi-budget').textContent = projectsOnBudget + '/' + projectsWithBudgets.length;
                document.getElementById('kpi-risk').textContent = atRiskProjects + ' at risk';
                
                // Update financial overview
                document.getElementById('exec-total-budget').textContent = '$' + totalBudget.toLocaleString();
                document.getElementById('exec-spent-budget').textContent = '$' + spentBudget.toLocaleString();
                document.getElementById('exec-remaining-budget').textContent = '$' + remainingBudget.toLocaleString();
                const budgetVariance = totalBudget > 0 ? Math.round(((spentBudget - totalBudget) / totalBudget) * 100) : 0;
                document.getElementById('exec-budget-util').textContent = (budgetVariance > 0 ? '+' : '') + budgetVariance + '%';
                
                // Generate strategic insights based on project data
                const insights = [];
                
                if (completionRate >= 80) {
                    insights.push({
                        type: 'success',
                        title: 'Excellent Completion Rate',
                        message: `${completionRate}% project completion rate is well above industry average.`
                    });
                } else if (completionRate < 60) {
                    insights.push({
                        type: 'warning',
                        title: 'Low Completion Rate',
                        message: `${completionRate}% completion rate needs attention. Consider reviewing project management processes.`
                    });
                }
                
                if (projectsWithBudgets.length > 0) {
                    const budgetPerformanceRate = Math.round((projectsOnBudget / projectsWithBudgets.length) * 100);
                    if (budgetPerformanceRate >= 80) {
                        insights.push({
                            type: 'success',
                            title: 'Excellent Budget Performance',
                            message: `${budgetPerformanceRate}% of projects are within budget variance (10%).`
                        });
                    } else if (budgetPerformanceRate < 60) {
                        insights.push({
                            type: 'warning',
                            title: 'Budget Variance Concerns',
                            message: `Only ${budgetPerformanceRate}% of projects are within budget. Review cost controls.`
                        });
                    }
                }
                
                if (atRiskProjects > 0) {
                    insights.push({
                        type: 'warning',
                        title: 'Projects at Risk',
                        message: `${atRiskProjects} project(s) require immediate attention to prevent delays.`
                    });
                } else {
                    insights.push({
                        type: 'success',
                        title: 'All Projects on Track',
                        message: 'No projects are currently at risk of delays or budget overruns.'
                    });
                }
                
                // Update strategic insights
                const insightsContainer = document.getElementById('strategicInsights');
                if (insightsContainer) {
                    insightsContainer.innerHTML = insights.map(insight => `
                        <div class="insight-card insight-${insight.type}">
                            <div class="insight-header">
                                <span class="insight-icon">${insight.type === 'success' ? '' : insight.type === 'warning' ? '' : ''}</span>
                                <strong>${insight.title}</strong>
                            </div>
                            <p>${insight.message}</p>
                        </div>
                    `).join('');
                }
                
                // Update critical projects with actual at-risk projects
                const criticalProjects = projects.filter(p => {
                    if (p.status === 'completed') return false;
                    if (p.endDate && new Date(p.endDate) < new Date()) return true;
                    if (p.progress < 50 && p.status === 'active') return true;
                    return false;
                }).slice(0, 5); // Top 5 critical projects
                
                const criticalContainer = document.getElementById('criticalProjects');
                if (criticalContainer) {
                    if (criticalProjects.length > 0) {
                        criticalContainer.innerHTML = criticalProjects.map(project => {
                            const isOverdue = project.endDate && new Date(project.endDate) < new Date();
                            return `
                                <div class="critical-project-item">
                                    <div class="critical-project-name">${project.name}</div>
                                    <div class="critical-project-details">
                                        <span class="status-badge ${project.status}">${formatStatus(project.status)}</span>
                                        <span class="progress">${project.progress || 0}% complete</span>
                                        ${isOverdue ? '<span class="overdue-badge">OVERDUE</span>' : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        criticalContainer.innerHTML = '<div class="no-critical">No critical projects at this time </div>';
                    }
                }
                
            } catch (error) {
                console.error('Error loading executive summary:', error);
                showNotification('Failed to load executive summary', 'error');
            }
        }

        // ==================== CHART FUNCTIONS ====================
        let reportCharts = {};

        async function renderReportCharts() {
            try {
                const period = document.getElementById('reportPeriod')?.value || '30';
                const userRole = AppState.user?.role?.toLowerCase() || 'client';
                
                // Role-based chart visibility
                const chartPermissions = {
                    'client': ['performance', 'status'],
                    'technician': ['performance', 'status', 'taskrag'],
                    'team-lead': ['performance', 'status', 'taskrag', 'budget'],
                    'project-manager': ['performance', 'status', 'taskrag', 'budget'],
                    'admin': ['performance', 'status', 'taskrag', 'budget']
                };
                
                const allowedCharts = chartPermissions[userRole] || ['performance', 'status'];
                
                // Hide charts not allowed for this role
                const chartContainers = {
                    'performance': 'performanceChart',
                    'status': 'statusDistributionChart', 
                    'taskrag': 'taskRAGChart',
                    'budget': 'budgetAnalysisChart'
                };
                
                Object.entries(chartContainers).forEach(([chartType, containerId]) => {
                    const container = document.getElementById(containerId)?.parentElement?.parentElement;
                    if (container) {
                        container.style.display = allowedCharts.includes(chartType) ? 'block' : 'none';
                    }
                });
                
                // Render allowed charts
                const renderPromises = [];
                if (allowedCharts.includes('performance')) {
                    renderPromises.push(renderPerformanceChart('progress', period));
                }
                if (allowedCharts.includes('status')) {
                    renderPromises.push(renderStatusDistributionChart(period));
                }
                if (allowedCharts.includes('taskrag')) {
                    renderPromises.push(renderTaskRAGChart(period));
                }
                if (allowedCharts.includes('budget')) {
                    renderPromises.push(renderBudgetAnalysisChart(period));
                }
                
                await Promise.all(renderPromises);
                
            } catch (error) {
                console.error('Error rendering report charts:', error);
            }
        }


        async function renderPerformanceChart(type = 'progress', period = '30') {
            try {
                const projects = AppState.projects || [];
                const ctx = document.getElementById('performanceChart');
                if (!ctx) return;

                // Destroy existing chart
                if (reportCharts.performance) {
                    reportCharts.performance.destroy();
                }

                // Generate chart data from actual projects
                const chartData = generatePerformanceChartData(projects, type);
                if (!chartData) return;

                const config = {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { usePointStyle: true }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0, 0, 0, 0.1)' },
                                ticks: { 
                                    callback: function(value) {
                                        return type === 'budget' ? '$' + value.toLocaleString() : value + '%';
                                    }
                                }
                            },
                            x: { grid: { display: false } }
                        },
                        elements: {
                            point: { radius: 4, hoverRadius: 6 },
                            line: { tension: 0.4 }
                        }
                    }
                };

                reportCharts.performance = new Chart(ctx, config);
            } catch (error) {
                console.error('Error rendering performance chart:', error);
            }
        }

        function generatePerformanceChartData(projects, type) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            const data = [];
            
            // Sample data generation - in real app this would use actual historical data
            for (let i = 0; i < months.length; i++) {
                if (type === 'progress') {
                    data.push(Math.round(60 + (i * 8) + (Math.random() * 10)));
                } else if (type === 'budget') {
                    data.push(Math.round(75 + (i * 5) + (Math.random() * 8)));
                } else {
                    data.push(Math.round(80 + (i * 3) + (Math.random() * 5)));
                }
            }
            
            return {
                labels: months,
                datasets: [{
                    label: type === 'progress' ? 'Progress %' : type === 'budget' ? 'Budget Utilization %' : 'Timeline Accuracy %',
                    data: data,
                    borderColor: 'rgb(14, 165, 233)',
                    backgroundColor: 'rgba(14, 165, 233, 0.1)',
                    fill: true
                }]
            };
        }

        function generateStatusChartData(projects) {
            // Red/Yellow/Green status based on project health
            const ragStatus = {
                green: 0,
                yellow: 0, 
                red: 0
            };

            projects.forEach(project => {
                const health = calculateProjectHealth(project);
                if (health === 'green') ragStatus.green++;
                else if (health === 'yellow') ragStatus.yellow++;
                else ragStatus.red++;
            });

            return {
                labels: ['On Track (Green)', 'At Risk (Yellow)', 'Critical (Red)'],
                datasets: [{
                    data: [ragStatus.green, ragStatus.yellow, ragStatus.red],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',   // Green
                        'rgba(245, 158, 11, 0.8)',   // Yellow
                        'rgba(239, 68, 68, 0.8)'     // Red
                    ],
                    borderColor: [
                        'rgb(34, 197, 94)',   // Green
                        'rgb(245, 158, 11)',   // Yellow
                        'rgb(239, 68, 68)'     // Red
                    ],
                    borderWidth: 1
                }]
            };
        }

        function calculateProjectHealth(project) {
            // Green: On track, no issues
            // Yellow: Minor risks, behind schedule but manageable
            // Red: Major issues, significantly behind or over budget
            
            if (project.status === 'completed') {
                // Check if completed on time and on budget
                const onTime = !project.endDate || !project.dueDate || new Date(project.endDate) <= new Date(project.dueDate);
                const budgetVariance = project.actualBudget && project.estimatedBudget ? 
                    ((project.actualBudget - project.estimatedBudget) / project.estimatedBudget) * 100 : 0;
                
                if (onTime && budgetVariance <= 10) return 'green';
                else if (onTime && budgetVariance <= 25) return 'yellow';
                else return 'red';
            }
            
            if (project.status === 'cancelled') return 'red';
            if (project.status === 'on-hold') return 'yellow';
            
            // For active projects
            const now = new Date();
            const isOverdue = project.dueDate && new Date(project.dueDate) < now;
            const progress = project.progress || 0;
            
            // Calculate expected progress based on timeline
            let expectedProgress = 0;
            if (project.startDate && project.dueDate) {
                const total = new Date(project.dueDate) - new Date(project.startDate);
                const elapsed = now - new Date(project.startDate);
                expectedProgress = Math.min(100, Math.max(0, (elapsed / total) * 100));
            }
            
            const progressGap = expectedProgress - progress;
            
            if (isOverdue) return 'red';
            if (progressGap > 20) return 'red';    // More than 20% behind schedule
            if (progressGap > 10) return 'yellow'; // 10-20% behind schedule
            if (progress >= 90) return 'green';    // Nearly complete
            if (progressGap > 0) return 'yellow';  // Slightly behind
            return 'green';                        // On track or ahead
        }

        function loadFinancialReport() {
            console.log('Loading financial report...');
            showNotification('Financial report loaded', 'success');
            // Switch to analytics view with financial data
            showReportType('analytics');
        }

        function loadTeamPerformanceReport() {
            console.log('Loading team performance report...');
            showNotification('Team performance report loaded', 'success');
            // Switch to analytics view with team data
            showReportType('analytics');
        }

        async function renderTaskRAGChart(period = '30') {
            try {
                const projects = AppState.projects || [];
                const chartData = generateTaskRAGChartData(projects);
                const ctx = document.getElementById('taskRAGChart');
                if (!ctx) return;

                if (reportCharts.taskRAG) {
                    reportCharts.taskRAG.destroy();
                }

                reportCharts.taskRAG = new Chart(ctx, {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { usePointStyle: true }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
                                        return `${context.label}: ${context.parsed} tasks (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering task RAG chart:', error);
            }
        }

        function generateTaskRAGChartData(projects) {
            let greenTasks = 0, yellowTasks = 0, redTasks = 0;
            
            projects.forEach(project => {
                if (project.tasks) {
                    project.tasks.forEach(task => {
                        const ragStatus = task.ragStatus || 'yellow';
                        if (ragStatus === 'green') greenTasks++;
                        else if (ragStatus === 'yellow') yellowTasks++;
                        else redTasks++;
                    });
                }
            });

            return {
                labels: ['Green - On Track', 'Yellow - At Risk', 'Red - Critical'],
                datasets: [{
                    data: [greenTasks, yellowTasks, redTasks],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',   // Green
                        'rgba(245, 158, 11, 0.8)',   // Yellow
                        'rgba(239, 68, 68, 0.8)'     // Red
                    ],
                    borderColor: [
                        'rgb(34, 197, 94)',   // Green
                        'rgb(245, 158, 11)',   // Yellow
                        'rgb(239, 68, 68)'     // Red
                    ],
                    borderWidth: 1
                }]
            };
        }

        function generateBudgetVarianceChartData(projects) {
            // Filter projects that have both estimated and actual budgets
            const projectsWithBudgets = projects.filter(p => p.estimatedBudget && p.actualBudget);
            
            const labels = projectsWithBudgets.map(p => p.name.length > 20 ? p.name.substring(0, 17) + '...' : p.name);
            const estimatedBudgets = projectsWithBudgets.map(p => p.estimatedBudget);
            const actualBudgets = projectsWithBudgets.map(p => p.actualBudget);
            
            return {
                labels: labels,
                datasets: [{
                    label: 'Estimated Budget',
                    data: estimatedBudgets,
                    backgroundColor: 'rgba(14, 165, 233, 0.6)',
                    borderColor: 'rgb(14, 165, 233)',
                    borderWidth: 1
                }, {
                    label: 'Actual Budget',
                    data: actualBudgets,
                    backgroundColor: 'rgba(239, 68, 68, 0.6)',
                    borderColor: 'rgb(239, 68, 68)',
                    borderWidth: 1
                }]
            };
        }

        async function renderStatusDistributionChart(period = '30') {
            try {
                const projects = AppState.projects || [];
                const chartData = generateStatusChartData(projects);
                const ctx = document.getElementById('statusDistributionChart');
                if (!ctx) return;

                if (reportCharts.statusDistribution) {
                    reportCharts.statusDistribution.destroy();
                }

                const colors = {
                    'Active': '#22c55e',
                    'Completed': '#0ea5e9', 
                    'On-hold': '#f59e0b',
                    'Cancelled': '#ef4444',
                    'Draft': '#6b7280'
                };

                reportCharts.statusDistribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            data: chartData.datasets[0].data,
                            backgroundColor: chartData.labels.map(label => colors[label] || '#6b7280'),
                            borderWidth: 0,
                            cutout: '60%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { 
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: ${context.parsed} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering status distribution chart:', error);
            }
        }

        async function renderTeamUtilizationChart(period = '30') {
            try {
                // Mock team utilization data - in real app, this would come from API
                const teamData = {
                    labels: ['John Smith', 'Sarah Davis', 'Mike Johnson', 'Emily Brown', 'David Wilson'],
                    datasets: [{
                        label: 'Current Workload',
                        data: [85, 92, 67, 78, 88],
                        backgroundColor: 'rgba(34, 197, 94, 0.6)',
                        borderColor: 'rgb(34, 197, 94)',
                        borderWidth: 2
                    }, {
                        label: 'Capacity',
                        data: [100, 100, 100, 100, 100],
                        backgroundColor: 'rgba(156, 163, 175, 0.3)',
                        borderColor: 'rgb(156, 163, 175)',
                        borderWidth: 1
                    }]
                };

                const ctx = document.getElementById('teamUtilizationChart');
                if (!ctx) return;

                if (reportCharts.teamUtilization) {
                    reportCharts.teamUtilization.destroy();
                }

                reportCharts.teamUtilization = new Chart(ctx, {
                    type: 'bar',
                    data: teamData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) { return value + '%'; }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering team utilization chart:', error);
            }
        }

        async function renderBudgetAnalysisChart(period = '30') {
            try {
                const projects = AppState.projects || [];
                const chartData = generateBudgetVarianceChartData(projects);
                const ctx = document.getElementById('budgetAnalysisChart');
                if (!ctx) return;

                if (reportCharts.budgetAnalysis) {
                    reportCharts.budgetAnalysis.destroy();
                }

                reportCharts.budgetAnalysis = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: $${context.parsed.y.toLocaleString()}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering budget analysis chart:', error);
            }
        }

        function switchPerformanceChart(type) {
            // Update button states
            document.querySelectorAll('.chart-toggle').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Re-render chart with new type
            const period = document.getElementById('reportPeriod')?.value || '30';
            renderPerformanceChart(type, period);
        }

        async function loadProjectSummaryTable() {
            try {
                const projects = AppState.projects || [];
                const tbody = document.getElementById('projectSummaryBody');
                const userRole = AppState.user?.role?.toLowerCase() || 'client';
                
                // Role-based column filtering
                const columnPermissions = {
                    'client': ['name', 'status', 'progress', 'timeline'],
                    'technician': ['name', 'status', 'progress', 'timeline'],
                    'team-lead': ['name', 'status', 'progress', 'budget', 'timeline', 'risk'],
                    'project-manager': ['name', 'status', 'progress', 'budget', 'timeline', 'risk'],
                    'admin': ['name', 'status', 'progress', 'budget', 'timeline', 'risk']
                };
                
                const allowedColumns = columnPermissions[userRole] || ['name', 'status', 'progress', 'timeline'];
                
                // Update table headers based on role
                const tableHeaders = document.querySelector('#projectSummaryTable thead tr');
                if (tableHeaders) {
                    const headerMap = ['name', 'status', 'progress', 'budget', 'timeline', 'risk'];
                    const headers = tableHeaders.querySelectorAll('th');
                    headers.forEach((header, index) => {
                        const columnType = headerMap[index];
                        header.style.display = allowedColumns.includes(columnType) ? '' : 'none';
                    });
                }
                
                tbody.innerHTML = projects.map(project => {
                    // Calculate budget variance
                    const budgetVariance = project.estimatedBudget && project.actualBudget
                        ? Math.round(((project.actualBudget - project.estimatedBudget) / project.estimatedBudget) * 100)
                        : null;
                    
                    // Get RAG status
                    const ragStatus = calculateProjectHealth(project);
                    const ragInfo = {
                        'green': { label: 'Green', class: 'rag-green', icon: '' },
                        'yellow': { label: 'Yellow', class: 'rag-yellow', icon: '' },
                        'red': { label: 'Red', class: 'rag-red', icon: '' }
                    };
                    
                    // Calculate deliverables status
                    const totalTasks = project.tasks ? project.tasks.length : 0;
                    const completedTasks = project.tasks ? project.tasks.filter(t => t.status === 'completed').length : 0;
                    
                    // Build row with role-based column visibility
                    const cells = [
                        `<td><strong>${project.name}</strong></td>`, // name
                        `<td><span class="${ragInfo[ragStatus].class}">${ragInfo[ragStatus].icon} ${ragInfo[ragStatus].label}</span></td>`, // RAG status
                        `<td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${project.progress || 0}%"></div>
                                <span class="progress-text">${project.progress || 0}%</span>
                            </div>
                        </td>`, // progress
                        `<td>
                            ${budgetVariance !== null ?
                                `<span class="${budgetVariance > 10 ? 'text-danger' : budgetVariance > -10 ? 'text-warning' : 'text-success'}">
                                    ${budgetVariance > 0 ? '+' : ''}${budgetVariance}%
                                </span>` :
                                '<span class="text-muted">No data</span>'
                            }
                        </td>`, // budget variance
                        `<td>
                            ${project.dueDate ? 
                                new Date(project.dueDate) < new Date() && project.status !== 'completed' ? 
                                    `<span class="text-danger"> Overdue</span>` :
                                    `<span class="text-success"> ${formatDate(project.dueDate)}</span>`
                                : '<span class="text-muted">No deadline</span>'
                            }
                        </td>`, // timeline status
                        `<td>
                            <span>${completedTasks}/${totalTasks} tasks</span>
                            ${totalTasks > 0 ? `<div class="progress-bar small"><div class="progress-fill" style="width: ${(completedTasks/totalTasks)*100}%"></div></div>` : ''}
                        </td>` // deliverables
                    ];
                    
                    const headerMap = ['name', 'status', 'progress', 'budget', 'timeline', 'risk'];
                    const visibleCells = cells.filter((cell, index) => allowedColumns.includes(headerMap[index]));
                    
                    return `<tr>${visibleCells.join('')}</tr>`;
                }).join('');
                
            } catch (error) {
                console.error('Error loading project summary:', error);
                document.getElementById('projectSummaryBody').innerHTML = `
                    <tr><td colspan="6" style="text-align: center; color: var(--gray-500);">
                        Failed to load project data
                    </td></tr>
                `;
            }
        }

        async function exportReport() {
            const exportButton = event.target;
            const originalText = exportButton.innerHTML;
            exportButton.innerHTML = ' Exporting...';
            exportButton.disabled = true;

            try {
                // Show export options modal
                const exportType = await showExportModal();
                if (!exportType) {
                    exportButton.innerHTML = originalText;
                    exportButton.disabled = false;
                    return;
                }

                const reportData = await generateReportData();
                
                if (exportType === 'pdf') {
                    await exportToPDF(reportData);
                } else if (exportType === 'excel') {
                    await exportToExcel(reportData);
                } else if (exportType === 'json') {
                    await exportToJSON(reportData);
                }

                showNotification('Report exported successfully!', 'success');
            } catch (error) {
                console.error('Export failed:', error);
                showNotification('Export failed. Please try again.', 'error');
            } finally {
                exportButton.innerHTML = originalText;
                exportButton.disabled = false;
            }
        }

        function showExportModal() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'export-modal-overlay';
                modal.innerHTML = `
                    <div class="export-modal">
                        <div class="export-modal-header">
                            <h3>Export Report</h3>
                            <button class="close-btn" onclick="this.closest('.export-modal-overlay').remove(); resolve(null);"></button>
                        </div>
                        <div class="export-modal-body">
                            <p>Choose your export format:</p>
                            <div class="export-options">
                                <button class="export-option-btn" onclick="selectExport('pdf')">
                                     PDF Report
                                    <small>Professional formatted document</small>
                                </button>
                                <button class="export-option-btn" onclick="selectExport('excel')">
                                     Excel Spreadsheet
                                    <small>Data tables with formulas</small>
                                </button>
                                <button class="export-option-btn" onclick="selectExport('json')">
                                     JSON Data
                                    <small>Raw data for external systems</small>
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                window.selectExport = (type) => {
                    modal.remove();
                    delete window.selectExport;
                    resolve(type);
                };

                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(null);
                    }
                });
            });
        }

        async function generateReportData() {
            const period = document.getElementById('reportPeriod')?.value || '30';
            const userRole = AppState.user?.role?.toLowerCase() || 'client';
            
            // Gather all report data
            const [metricsData, chartData, projectsData] = await Promise.all([
                DashboardAPI.getMetrics(),
                DashboardAPI.getChartData('status', period),
                DashboardAPI.getRecentProjects(50)
            ]);

            return {
                reportInfo: {
                    title: 'Project Analytics Report',
                    generated: new Date().toISOString(),
                    period: period + ' days',
                    userRole: userRole,
                    user: AppState.user
                },
                metrics: metricsData.metrics,
                charts: chartData,
                projects: projectsData.projects,
                summary: {
                    totalProjects: projectsData.projects.length,
                    activeProjects: projectsData.projects.filter(p => p.status === 'active').length,
                    completedProjects: projectsData.projects.filter(p => p.status === 'completed').length,
                    averageProgress: Math.round(
                        projectsData.projects.reduce((sum, p) => sum + p.progress, 0) / 
                        projectsData.projects.length
                    ),
                    overdueProjects: projectsData.projects.filter(p => p.isOverdue).length
                }
            };
        }

        async function exportToPDF(reportData) {
            // Use jsPDF library for PDF generation (would need to be included)
            // For now, create a printable HTML version
            const printWindow = window.open('', '_blank');
            const printHTML = generatePrintHTML(reportData);
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
            printWindow.print();
        }

        async function exportToExcel(reportData) {
            // Create Excel-compatible CSV data
            const csvData = generateCSVData(reportData);
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `project-report-${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function exportToJSON(reportData) {
            const jsonString = JSON.stringify(reportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `project-data-${new Date().getTime()}.json`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function generatePrintHTML(reportData) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${reportData.reportInfo.title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 2rem; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 1rem; margin-bottom: 2rem; }
                        .section { margin-bottom: 2rem; }
                        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1rem 0; }
                        .metric-card { border: 1px solid #ccc; padding: 1rem; text-align: center; }
                        .table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
                        .table th, .table td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
                        .table th { background: #f5f5f5; }
                        @media print { body { margin: 1rem; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${reportData.reportInfo.title}</h1>
                        <p>Generated: ${new Date(reportData.reportInfo.generated).toLocaleString()}</p>
                        <p>Period: Last ${reportData.reportInfo.period}</p>
                    </div>
                    
                    <div class="section">
                        <h2>Executive Summary</h2>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <h3>${reportData.summary.totalProjects}</h3>
                                <p>Total Projects</p>
                            </div>
                            <div class="metric-card">
                                <h3>${reportData.summary.activeProjects}</h3>
                                <p>Active Projects</p>
                            </div>
                            <div class="metric-card">
                                <h3>${reportData.summary.averageProgress}%</h3>
                                <p>Average Progress</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>Project Details</h2>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Project Name</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Client</th>
                                    <th>End Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.projects.map(project => `
                                    <tr>
                                        <td>${project.name}</td>
                                        <td>${formatStatus(project.status)}</td>
                                        <td>${project.progress}%</td>
                                        <td>${project.client}</td>
                                        <td>${project.endDate ? formatDate(project.endDate) : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </body>
                </html>
            `;
        }

        function generateCSVData(reportData) {
            const headers = [
                'Project Name', 
                'Requestor Information', 
                'Site/Location', 
                'Business Line', 
                'Project Type',
                'Priority',
                'Status', 
                'Progress %', 
                'Request Date',
                'Start Date', 
                'Due Date', 
                'Estimated Budget', 
                'Actual Budget',
                'Budget Utilization %',
                'Days Remaining',
                'Is Overdue',
                'Tasks Total',
                'Tasks Completed'
            ];
            
            const rows = reportData.projects.map(project => {
                const budgetUtilization = project.estimatedBudget > 0 
                    ? Math.round((project.actualBudget / project.estimatedBudget) * 100)
                    : 0;
                    
                const daysRemaining = project.dueDate || project.endDate ? 
                    Math.ceil((new Date(project.dueDate || project.endDate) - new Date()) / (1000 * 60 * 60 * 24)) : 
                    '';
                    
                return [
                    project.name,
                    project.requestorInfo || '',
                    project.siteLocation || '',
                    formatBusinessLine(project.businessLine),
                    formatProjectType(project.type),
                    formatStatus(project.priority),
                    formatStatus(project.status),
                    project.progress,
                    project.requestDate || '',
                    project.startDate || '',
                    project.dueDate || project.endDate || '',
                    project.estimatedBudget || 0,
                    project.actualBudget || 0,
                    budgetUtilization,
                    daysRemaining,
                    (project.isOverdue || daysRemaining < 0) ? 'Yes' : 'No',
                    project.tasks ? project.tasks.length : 0,
                    project.tasks ? project.tasks.filter(t => t.status === 'completed').length : 0
                ];
            });

            const csvContent = [headers, ...rows]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');

            return csvContent;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    ${type === 'success' ? '' : type === 'error' ? '' : ''} ${message}
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ==================== ADMINISTRATION ====================
        
        // Enhanced AppState to include roles and audit data
        // Initialize administration data only after AppState is defined
        function initializeAdminData() {
            if (!AppState.roles) {
            AppState.roles = [
                {
                    id: 'admin',
                    name: 'Administrator',
                    description: 'Full system access with all permissions',
                    permissions: [
                        'view_all_projects',
                        'create_projects',
                        'edit_projects',
                        'delete_projects',
                        'manage_users',
                        'manage_roles',
                        'system_settings',
                        'view_audit_log'
                    ],
                    userCount: 1
                },
                {
                    id: 'manager',
                    name: 'Project Manager',
                    description: 'Manage projects and assigned team members',
                    permissions: [
                        'view_all_projects',
                        'create_projects',
                        'edit_projects',
                        'assign_tasks',
                        'view_reports'
                    ],
                    userCount: 1
                },
                {
                    id: 'technician',
                    name: 'Technician',
                    description: 'View and update assigned tasks',
                    permissions: [
                        'view_assigned_projects',
                        'update_task_status',
                        'view_project_details'
                    ],
                    userCount: 2
                },
                {
                    id: 'viewer',
                    name: 'Viewer',
                    description: 'Read-only access to assigned projects',
                    permissions: [
                        'view_assigned_projects',
                        'view_project_details'
                    ],
                    userCount: 1
                }
            ];
            }

            if (!AppState.auditLog) {
            AppState.auditLog = [
                {
                    id: 1,
                    timestamp: new Date().toISOString(),
                    user: 'John Smith',
                    action: 'login',
                    resource: 'System',
                    details: 'User logged in successfully',
                    ipAddress: '192.168.1.100'
                },
                {
                    id: 2,
                    timestamp: new Date(Date.now() - 3600000).toISOString(),
                    user: 'Sarah Johnson',
                    action: 'project',
                    resource: 'proj_2023_001',
                    details: 'Updated project status to completed',
                    ipAddress: '192.168.1.101'
                }
            ];
            }
        }

        function loadAdministration() {
            // Load users by default
            showAdminTab('users');
            loadUsers();
        }

        function showAdminTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`adminTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`admin${tab.charAt(0).toUpperCase() + tab.slice(1)}Content`).classList.add('active');

            // Update sidebar navigation
            updateAdminSidebarNav(tab);

            // Load tab-specific content
            switch (tab) {
                case 'users':
                    loadUsers();
                    break;
                case 'roles':
                    loadRoles();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'audit':
                    loadAuditLog();
                    break;
            }
        }

        function updateAdminSidebarNav(activeTab) {
            const navItems = document.querySelectorAll('.sidebar .nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            const tabMap = {
                'users': 0,
                'roles': 1,
                'settings': 2,
                'audit': 3
            };
            
            if (navItems[tabMap[activeTab]]) {
                navItems[tabMap[activeTab]].classList.add('active');
            }
        }

        function loadUsers() {
            const usersTableBody = document.getElementById('usersTableBody');
            
            usersTableBody.innerHTML = AppState.users.map(user => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <div class="user-avatar-small">${user.avatar}</div>
                            <div>
                                <div style="font-weight: 500;">${user.name}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <span class="status-badge ${user.role.toLowerCase()}">${user.role.replace('-', ' ')}</span>
                    </td>
                    <td>
                        <span class="status-badge active">Active</span>
                    </td>
                    <td>Just now</td>
                    <td>
                        <button class="action-btn edit" onclick="editUser(${user.id})"> Edit</button>
                        <button class="action-btn reset" onclick="resetUserPassword(${user.id})"> Reset Password</button>
                        <button class="action-btn delete" onclick="deleteUser(${user.id})"> Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function loadRoles() {
            const rolesGrid = document.getElementById('rolesGrid');
            
            rolesGrid.innerHTML = AppState.roles.map(role => `
                <div class="role-card">
                    <div class="role-card-header">
                        <div class="role-name">${role.name}</div>
                        <span class="role-users-count">${role.userCount} users</span>
                    </div>
                    <p style="margin-bottom: 1rem; color: var(--gray-600); font-size: 0.875rem;">${role.description}</p>
                    <ul class="permission-list">
                        ${role.permissions.slice(0, 4).map(perm => `
                            <li class="permission-item granted">
                                 ${perm.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                            </li>
                        `).join('')}
                        ${role.permissions.length > 4 ? `<li class="permission-item">...and ${role.permissions.length - 4} more</li>` : ''}
                    </ul>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="action-btn edit" onclick="editRole('${role.id}')"> Edit</button>
                        <button class="action-btn delete" onclick="deleteRole('${role.id}')" ${role.id === 'admin' ? 'disabled' : ''}> Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function loadSettings() {
            // Settings are already in the HTML, just focus on the first input
            document.getElementById('companyName').focus();
        }

        function loadAuditLog() {
            const auditTableBody = document.getElementById('auditTableBody');
            
            auditTableBody.innerHTML = AppState.auditLog.map(entry => `
                <tr>
                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <div class="user-avatar-small">${entry.user.charAt(0)}</div>
                            ${entry.user}
                        </div>
                    </td>
                    <td>
                        <span class="status-badge ${entry.action === 'login' ? 'active' : 'pending'}">${entry.action}</span>
                    </td>
                    <td>${entry.resource}</td>
                    <td>${entry.details}</td>
                    <td>${entry.ipAddress}</td>
                </tr>
            `).join('');
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const roleFilter = document.getElementById('userRoleFilter').value.toLowerCase();
            
            let filteredUsers = AppState.users;
            
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(user => 
                    user.name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm)
                );
            }
            
            if (roleFilter) {
                filteredUsers = filteredUsers.filter(user => 
                    user.role.toLowerCase().includes(roleFilter)
                );
            }
            
            const usersTableBody = document.getElementById('usersTableBody');
            usersTableBody.innerHTML = filteredUsers.map(user => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <div class="user-avatar-small">${user.avatar}</div>
                            <div>
                                <div style="font-weight: 500;">${user.name}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <span class="status-badge ${user.role.toLowerCase()}">${user.role.replace('-', ' ')}</span>
                    </td>
                    <td>
                        <span class="status-badge active">Active</span>
                    </td>
                    <td>Just now</td>
                    <td>
                        <button class="action-btn edit" onclick="editUser(${user.id})"> Edit</button>
                        <button class="action-btn reset" onclick="resetUserPassword(${user.id})"> Reset Password</button>
                        <button class="action-btn delete" onclick="deleteUser(${user.id})"> Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function showCreateUser() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2>Add New User</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <form onsubmit="createUser(event)">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" name="name" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" name="email" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Role</label>
                                <select name="role" class="form-control" required>
                                    <option value="">Select a role</option>
                                    ${AppState.roles.map(role => 
                                        `<option value="${role.id}">${role.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Temporary Password</label>
                                <input type="password" name="password" class="form-control" required>
                            </div>
                            
                            <div class="checkbox-group">
                                <label>
                                    <input type="checkbox" name="forcePasswordChange" checked>
                                    Require password change on first login
                                </label>
                            </div>
                            
                            <div class="form-actions" style="margin-top: 1.5rem;">
                                <button type="submit" class="btn btn-primary">Create User</button>
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function createUser(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const newUser = {
                id: AppState.users && AppState.users.length > 0 ? Math.max(...AppState.users.map(u => u.id)) + 1 : 1,
                name: formData.get('name'),
                email: formData.get('email'),
                password: formData.get('password'),
                role: AppState.roles.find(r => r.id === formData.get('role')).name,
                avatar: formData.get('name').split(' ').map(n => n[0]).join('')
            };
            
            AppState.users.push(newUser);
            
            // Update role user count
            const role = AppState.roles.find(r => r.id === formData.get('role'));
            if (role) role.userCount++;
            
            // Add audit entry
            AppState.auditLog.unshift({
                id: AppState.auditLog.length + 1,
                timestamp: new Date().toISOString(),
                user: AppState.user.name,
                action: 'user',
                resource: newUser.email,
                details: `Created new user account`,
                ipAddress: '192.168.1.100'
            });
            
            showNotification(`User "${newUser.name}" created successfully`, 'success');
            event.target.closest('.modal-overlay').remove();
            loadUsers();
        }

        function editUser(userId) {
            const user = AppState.users.find(u => u.id === userId);
            if (!user) return;
            
            showNotification(`Edit functionality for ${user.name} would open here`, 'info');
        }

        function resetUserPassword(userId) {
            const user = AppState.users.find(u => u.id === userId);
            if (!user) return;
            
            if (confirm(`Reset password for ${user.name}? They will receive an email with a temporary password.`)) {
                showNotification(`Password reset email sent to ${user.email}`, 'success');
                
                // Add audit entry
                AppState.auditLog.unshift({
                    id: AppState.auditLog.length + 1,
                    timestamp: new Date().toISOString(),
                    user: AppState.user.name,
                    action: 'user',
                    resource: user.email,
                    details: 'Password reset initiated',
                    ipAddress: '192.168.1.100'
                });
            }
        }

        function deleteUser(userId) {
            const user = AppState.users.find(u => u.id === userId);
            if (!user) return;
            
            if (user.email === 'admin@company.com') {
                showNotification('Cannot delete the primary administrator account', 'error');
                return;
            }
            
            if (confirm(`Delete user ${user.name}? This action cannot be undone.`)) {
                // Update role user count
                const roleName = user.role.toLowerCase().replace(' ', '');
                const role = AppState.roles.find(r => r.id === roleName);
                if (role) role.userCount--;
                
                AppState.users = AppState.users.filter(u => u.id !== userId);
                
                // Add audit entry
                AppState.auditLog.unshift({
                    id: AppState.auditLog.length + 1,
                    timestamp: new Date().toISOString(),
                    user: AppState.user.name,
                    action: 'user',
                    resource: user.email,
                    details: 'User account deleted',
                    ipAddress: '192.168.1.100'
                });
                
                showNotification(`User "${user.name}" deleted successfully`, 'success');
                loadUsers();
            }
        }

        function showCreateRole() {
            showNotification('Create role functionality would open here', 'info');
        }

        function editRole(roleId) {
            showNotification(`Edit role functionality for ${roleId} would open here`, 'info');
        }

        function deleteRole(roleId) {
            if (roleId === 'admin') {
                showNotification('Cannot delete the administrator role', 'error');
                return;
            }
            showNotification(`Delete role functionality for ${roleId} would open here`, 'info');
        }

        function saveSystemSettings() {
            const companyName = document.getElementById('companyName').value;
            const defaultStatus = document.getElementById('defaultProjectStatus').value;
            const sessionTimeout = document.getElementById('sessionTimeout').value;
            
            showNotification('System settings saved successfully', 'success');
            
            // Add audit entry
            AppState.auditLog.unshift({
                id: AppState.auditLog.length + 1,
                timestamp: new Date().toISOString(),
                user: AppState.user.name,
                action: 'system',
                resource: 'Settings',
                details: 'System settings updated',
                ipAddress: '192.168.1.100'
            });
        }

        function resetSystemSettings() {
            if (confirm('Reset all settings to default values?')) {
                document.getElementById('companyName').value = 'Wintrust Bank - Unified Communications';
                document.getElementById('defaultProjectStatus').value = 'active';
                document.getElementById('sessionTimeout').value = '60';
                
                showNotification('Settings reset to defaults', 'info');
            }
        }

        function filterAuditLog() {
            const fromDate = document.getElementById('auditFromDate').value;
            const toDate = document.getElementById('auditToDate').value;
            const actionFilter = document.getElementById('auditActionFilter').value;
            
            let filteredLog = [...AppState.auditLog];
            
            if (fromDate) {
                filteredLog = filteredLog.filter(entry => 
                    new Date(entry.timestamp) >= new Date(fromDate)
                );
            }
            
            if (toDate) {
                filteredLog = filteredLog.filter(entry => 
                    new Date(entry.timestamp) <= new Date(toDate)
                );
            }
            
            if (actionFilter) {
                filteredLog = filteredLog.filter(entry => 
                    entry.action === actionFilter
                );
            }
            
            const auditTableBody = document.getElementById('auditTableBody');
            auditTableBody.innerHTML = filteredLog.map(entry => `
                <tr>
                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <div class="user-avatar-small">${entry.user.charAt(0)}</div>
                            ${entry.user}
                        </div>
                    </td>
                    <td>
                        <span class="status-badge ${entry.action === 'login' ? 'active' : 'pending'}">${entry.action}</span>
                    </td>
                    <td>${entry.resource}</td>
                    <td>${entry.details}</td>
                    <td>${entry.ipAddress}</td>
                </tr>
            `).join('');
            
            showNotification(`Filtered audit log: ${filteredLog.length} entries found`, 'info');
        }

        function exportUserData() {
            const userData = AppState.users.map(user => ({
                name: user.name,
                email: user.email,
                role: user.role
            }));
            
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'users-export.json';
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification('User data exported successfully', 'success');
        }


        // ==================== AUTHENTICATION ====================
        function handleLogin(event) {
            try {
                event.preventDefault();
                console.log(' Form login attempt started');
                
                const formData = new FormData(event.target);
                const email = formData.get('email');
                const password = formData.get('password');
                
                console.log(' Email:', email);
                console.log(' Available users:', AppState.users.length);
                
                const user = AppState.users.find(u => u.email === email && u.password === password);
                
                if (user) {
                    console.log(' User found:', user.name);
                    loginUser(user);
                } else {
                    console.log(' User not found for email:', email);
                    showNotification('Invalid email or password', 'error');
                }
            } catch (error) {
                console.error(' Error in handleLogin:', error);
                showNotification('Login form error. Please try again.', 'error');
            }
        }

        function quickLogin(email, password) {
            try {
                console.log(' Quick login attempt for:', email);
                console.log(' Available users count:', AppState.users ? AppState.users.length : 0);
                console.log(' Users array:', AppState.users);
                
                if (!AppState.users || AppState.users.length === 0) {
                    console.error(' No users available in AppState');
                    showNotification('System error: No user accounts available', 'error');
                    return;
                }
                
                const user = AppState.users.find(u => u.email === email && u.password === password);
                if (user) {
                    console.log(' User found:', user.name, user.role);
                    loginUser(user);
                } else {
                    console.log(' User not found for:', email);
                    console.log(' Checking all users:');
                    AppState.users.forEach(u => console.log(`  - ${u.email} (${u.name})`));
                    showNotification('Demo account not found. Please check credentials.', 'error');
                }
            } catch (error) {
                console.error(' Error in quickLogin:', error);
                showNotification('Quick login error. Please try again.', 'error');
            }
        }

        function loginUser(user) {
            try {
                console.log(' Starting login process for:', user.name);
                
                AppState.isLoggedIn = true;
                AppState.user = user;
                AppState.currentView = 'dashboard';
                
                // Hide login screen and show app
                const loginScreen = document.getElementById('loginScreen');
                const mainApp = document.getElementById('mainApp');
                
                if (loginScreen) {
                    loginScreen.style.display = 'none';
                    console.log(' Login screen hidden');
                } else {
                    console.error(' Login screen element not found');
                }
                
                if (mainApp) {
                    mainApp.style.display = 'flex';
                    console.log(' Main app shown');
                } else {
                    console.error(' Main app element not found');
                }
                
                document.body.classList.add('logged-in');
                
                // Set up user info
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar) {
                    userAvatar.textContent = user.avatar;
                    console.log(' User avatar set');
                } else {
                    console.error(' User avatar element not found');
                }
                
                // Initialize the application
                try {
                    showView('dashboard');
                    console.log(' Dashboard view loaded');
                } catch (error) {
                    console.error(' Error loading dashboard view:', error);
                }
                
                try {
                    setupRoleBasedUI();
                    console.log(' Role-based UI set up');
                } catch (error) {
                    console.error(' Error setting up role-based UI:', error);
                }
                
                try {
                    initializeSampleData();
                    console.log(' Sample data initialized');
                } catch (error) {
                    console.error(' Error initializing sample data:', error);
                }
                
                showNotification(`Welcome back, ${user.name}!`, 'success');
                console.log(` Successfully logged in as ${user.name} (${user.role})`);
                
            } catch (error) {
                console.error(' Critical error during login process:', error);
                showNotification('Login failed due to system error. Please try again.', 'error');
                
                // Reset login state
                AppState.isLoggedIn = false;
                AppState.user = null;
                AppState.currentView = 'login';
            }
        }

        function logout() {
            AppState.isLoggedIn = false;
            AppState.user = null;
            AppState.currentView = 'login';
            
            // Show login screen and hide app
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.body.classList.remove('logged-in');
            
            showNotification('Logged out successfully', 'success');
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            console.log('Initial AppState.users:', AppState.users);
            
            // Initialize administration data
            initializeAdminData();
            
            console.log('After init AppState.users:', AppState.users);
            
            // Check if already logged in (for demo purposes, we'll start with login screen)
            if (AppState.isLoggedIn && AppState.user) {
                loginUser(AppState.user);
            } else {
                // Show login screen
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
            
            console.log(' AV Project Management 8.0 initialized');
        });

        function initializeSampleData() {
            // Check if we have projects in localStorage, if not add some sample data
            const existingProjects = localStorage.getItem('av_projects');
            if (!existingProjects || JSON.parse(existingProjects).length === 0) {
                const sampleProjects = [
                    {
                        id: '1',
                        name: 'Executive Conference Room AV Upgrade',
                        requestorInfo: 'Sarah Johnson, Facilities Manager, (555) 123-4567',
                        siteLocation: '1200 Corporate Blvd, Suite 500, Dallas, TX',
                        businessLine: 'corporate',
                        description: 'Complete AV upgrade for executive conference room including 4K display, wireless presentation, and integrated video conferencing',
                        type: 'upgrade',
                        priority: 'high',
                        status: 'active',
                        progress: 65,
                        requestDate: '2024-01-10',
                        startDate: '2024-01-15',
                        dueDate: '2024-02-15',
                        endDate: '2024-02-15',
                        estimatedBudget: 35000,
                        actualBudget: 22750,
                        tasks: [
                            { id: '1-1', name: 'Site Survey & Design', status: 'completed', progress: 100 },
                            { id: '1-2', name: 'Equipment Procurement', status: 'completed', progress: 100 },
                            { id: '1-3', name: 'Display & Control Installation', status: 'in-progress', progress: 60 },
                            { id: '1-4', name: 'System Programming & Testing', status: 'not-started', progress: 0 }
                        ]
                    },
                    {
                        id: '2',
                        name: 'New Hospital Patient Room Technology',
                        requestorInfo: 'Dr. Michael Chen, CTO, Regional Medical Center',
                        siteLocation: 'Regional Medical Center, 500 Health Plaza, Austin, TX',
                        businessLine: 'healthcare',
                        description: 'Install patient room technology including nurse call integration, bedside entertainment, and digital signage for new wing',
                        type: 'new-build',
                        priority: 'critical',
                        status: 'active',
                        progress: 25,
                        requestDate: '2024-01-05',
                        startDate: '2024-01-20',
                        dueDate: '2024-03-30',
                        endDate: '2024-03-30',
                        estimatedBudget: 125000,
                        actualBudget: 31250,
                        tasks: [
                            { id: '2-1', name: 'Infrastructure Planning', status: 'completed', progress: 100 },
                            { id: '2-2', name: 'Equipment Specification', status: 'in-progress', progress: 80 },
                            { id: '2-3', name: 'Installation Coordination', status: 'not-started', progress: 0 },
                            { id: '2-4', name: 'Staff Training Program', status: 'not-started', progress: 0 }
                        ]
                    },
                    {
                        id: '3',
                        name: 'University Lecture Hall Audio System',
                        requestorInfo: 'Prof. Lisa Williams, Dean of Engineering, State University',
                        siteLocation: 'Engineering Building, Room 201, State University Campus',
                        businessLine: 'education',
                        description: 'Install modern audio system for 300-seat lecture hall with wireless microphones and hearing loop system',
                        type: 'upgrade',
                        priority: 'medium',
                        status: 'completed',
                        progress: 100,
                        requestDate: '2023-11-15',
                        startDate: '2023-12-01',
                        dueDate: '2023-12-20',
                        endDate: '2023-12-20',
                        estimatedBudget: 45000,
                        actualBudget: 43200,
                        tasks: [
                            { id: '3-1', name: 'Acoustic Analysis', status: 'completed', progress: 100 },
                            { id: '3-2', name: 'System Design', status: 'completed', progress: 100 },
                            { id: '3-3', name: 'Equipment Installation', status: 'completed', progress: 100 },
                            { id: '3-4', name: 'System Commissioning', status: 'completed', progress: 100 }
                        ]
                    },
                    {
                        id: '4',
                        name: 'Hotel Security Camera Repair',
                        requestorInfo: 'James Rodriguez, Security Director, Grand Plaza Hotel',
                        siteLocation: 'Grand Plaza Hotel, 789 Downtown Ave, Houston, TX',
                        businessLine: 'hospitality',
                        description: 'Emergency repair of security camera system damaged during severe weather - 12 cameras offline',
                        type: 'breakfix',
                        priority: 'critical',
                        status: 'active',
                        progress: 80,
                        requestDate: '2024-02-01',
                        startDate: '2024-02-01',
                        dueDate: '2024-02-05',
                        endDate: '2024-02-05',
                        estimatedBudget: 8500,
                        actualBudget: 6800,
                        tasks: [
                            { id: '4-1', name: 'Damage Assessment', status: 'completed', progress: 100 },
                            { id: '4-2', name: 'Equipment Replacement', status: 'in-progress', progress: 90 },
                            { id: '4-3', name: 'System Reconfiguration', status: 'not-started', progress: 0 }
                        ]
                    },
                    {
                        id: '5',
                        name: 'Custom Board Room Integration',
                        requestorInfo: 'Amanda Foster, IT Director, Sterling Financial',
                        siteLocation: 'Sterling Financial Tower, 42nd Floor, New York, NY',
                        businessLine: 'corporate',
                        description: 'Custom integration solution for board room with automated lighting, climate control, and presentation systems',
                        type: 'custom',
                        priority: 'high',
                        status: 'active',
                        progress: 40,
                        requestDate: '2024-01-08',
                        startDate: '2024-01-25',
                        dueDate: '2024-03-15',
                        endDate: '2024-03-15',
                        estimatedBudget: 75000,
                        actualBudget: 30000,
                        tasks: [
                            { id: '5-1', name: 'Requirements Analysis', status: 'completed', progress: 100 },
                            { id: '5-2', name: 'Custom Programming', status: 'in-progress', progress: 70 },
                            { id: '5-3', name: 'Hardware Installation', status: 'not-started', progress: 0 },
                            { id: '5-4', name: 'User Training', status: 'not-started', progress: 0 }
                        ]
                    }
                ];
                
                localStorage.setItem('av_projects', JSON.stringify(sampleProjects));
                console.log(' Sample project data initialized');
            }
        }

        function setupRoleBasedUI() {
            const userRole = AppState.user?.role?.toLowerCase() || 'client';
            
            // Hide Executive tab for non-admin/project-manager roles
            const executiveTab = document.getElementById('executiveTab');
            if (executiveTab && !['admin', 'project-manager'].includes(userRole)) {
                executiveTab.style.display = 'none';
            }
        }
    </script>
</body>
</html>